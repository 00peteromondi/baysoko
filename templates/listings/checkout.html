{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load crispy_forms_tags %}

{% block title %}Checkout - Baysoko{% endblock %}

{% block extra_css %}
<style>
    /* ===== GLOBAL STYLES ===== */
    .container-custom {
        padding-left: 8px;
        padding-right: 8px;
    }
    
    /* ===== BREADCRUMB ===== */
    .breadcrumb {
        background: var(--bg-secondary);
        padding: 10px 12px;
        border-radius: var(--radius-md);
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        font-size: 12px;
    }
    
    .breadcrumb-item a {
        text-decoration: none;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
    }
    
    /* ===== CHECKOUT HERO SECTION ===== */
    .checkout-hero {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        position: relative;
    }
    
    .checkout-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        padding: 16px;
        color: white;
    }
    
    .checkout-header h1 {
        font-size: 18px;
        font-weight: 800;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* ===== STEP INDICATOR ===== */
    .step-indicator {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        position: relative;
        flex: 1;
    }
    
    .step.active .step-number {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-color: var(--primary);
    }
    
    .step.completed .step-number {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .step-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-secondary);
        text-align: center;
        white-space: nowrap;
    }
    
    .step.active .step-label {
        color: var(--primary);
        font-weight: 700;
    }
    
    .step-line {
        flex: 1;
        height: 2px;
        background: var(--border-color);
        margin: 0 8px;
        position: relative;
        top: -16px;
    }
    
    .step-line.active {
        background: var(--primary);
    }
    
    /* ===== FORM SECTIONS ===== */
    .form-section {
        padding: 16px;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: 800;
        margin-bottom: 16px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .section-title i {
        color: var(--primary);
        background: rgba(255, 107, 53, 0.1);
        padding: 8px;
        border-radius: 8px;
        font-size: 14px;
    }
    
    /* Form Fields */
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    .form-control.is-invalid {
        border-color: var(--danger);
        background: rgba(234, 67, 53, 0.05);
    }
    
    /* Form Switches */
    .form-switch {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        cursor: pointer;
    }
    
    .switch-control {
        position: relative;
        width: 44px;
        height: 24px;
    }
    
    .switch-input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .switch-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--border-color);
        border-radius: 24px;
        transition: .4s;
    }
    
    .switch-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: .4s;
    }
    
    .switch-input:checked + .switch-slider {
        background: var(--primary);
    }
    
    .switch-input:checked + .switch-slider:before {
        transform: translateX(20px);
    }
    
    .switch-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    /* Info Cards */
    .info-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 12px;
        transition: all 0.2s ease;
    }
    
    .info-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }
    
    .info-card h6 {
        margin-bottom: 8px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 700;
    }
    
    /* ===== ORDER SUMMARY CARD ===== */
    .order-summary-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
    }
    
    .summary-header {
        background: var(--bg-secondary);
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .summary-header h3 {
        font-size: 16px;
        font-weight: 800;
        margin: 0;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .summary-content {
        padding: 16px;
    }
    
    /* Order Items */
    .order-items {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 16px;
        padding-right: 4px;
    }
    
    .order-items::-webkit-scrollbar {
        width: 4px;
    }
    
    .order-items::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 2px;
    }
    
    .order-items::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 2px;
    }
    
    .order-item {
        display: flex;
        gap: 12px;
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }
    
    .order-item:hover {
        background: var(--bg-secondary);
        border-radius: 8px;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .item-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }
    
    .item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .order-item:hover .item-image img {
        transform: scale(1.05);
    }
    
    .item-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .item-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
        line-height: 1.3;
    }
    
    .item-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .item-price {
        font-weight: 700;
        font-size: 14px;
        color: var(--primary);
    }
    
    /* Totals */
    .totals-section {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: 12px;
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 14px;
    }
    
    .total-row.total {
        font-weight: 800;
        font-size: 18px;
        color: var(--primary);
        border-top: 1px solid var(--border-color);
        padding-top: 10px;
        margin-top: 6px;
    }
    
    /* Buttons */
    .btn-checkout {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 700;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-checkout:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-checkout:active {
        transform: translateY(0);
    }
    
    .btn-checkout:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }
    
    /* ===== SECURITY INFO ===== */
    .security-info {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: 12px;
        border: 1px solid var(--border-color);
        margin-top: 16px;
    }
    
    .security-info h6 {
        margin-bottom: 8px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 700;
    }
    
    .security-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .security-list li {
        padding: 4px 0;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
    }
    
    .security-list li i {
        color: var(--success);
        font-size: 12px;
    }
    
    /* ===== HELP CARD ===== */
    .help-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 16px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-top: 20px;
    }
    
    .help-card h6 {
        margin-bottom: 12px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 700;
    }
    
    .help-contact {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .contact-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 13px;
        text-decoration: none;
        transition: color 0.2s ease;
    }
    
    .contact-item:hover {
        color: var(--primary);
    }
    
    .contact-item i {
        color: var(--primary);
        font-size: 14px;
    }
    
    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
    }
    
    .toast {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(10px);
    }
    
    .toast-body {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-primary);
    }
    
    /* ===== RESPONSIVE DESIGN ===== */
    
    /* Small phones (320px - 374px) */
    @media (max-width: 374px) {
        .container-custom {
            padding-left: 6px;
            padding-right: 6px;
        }
        
        .checkout-header {
            padding: 12px;
        }
        
        .checkout-header h1 {
            font-size: 16px;
        }
        
        .step-indicator {
            padding: 8px 12px;
        }
        
        .step-number {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        
        .step-label {
            font-size: 9px;
        }
        
        .form-section {
            padding: 12px;
        }
        
        .section-title {
            font-size: 14px;
        }
    }
    
    /* Medium phones (375px - 424px) */
    @media (min-width: 375px) and (max-width: 424px) {
        .checkout-header h1 {
            font-size: 17px;
        }
        
        .step-label {
            font-size: 10px;
        }
    }
    
    /* Large phones (425px - 575px) */
    @media (min-width: 425px) and (max-width: 575px) {
        .checkout-header h1 {
            font-size: 18px;
        }
    }
    
    /* Tablets (576px - 767px) */
    @media (min-width: 576px) {
        .container-custom {
            padding-left: 16px;
            padding-right: 16px;
        }
        
        .checkout-header {
            padding: 20px;
        }
        
        .checkout-header h1 {
            font-size: 22px;
        }
        
        .form-section {
            padding: 20px;
        }
        
        .section-title {
            font-size: 18px;
        }
        
        .step-label {
            font-size: 12px;
        }
    }
    
    /* Desktop (768px and above) */
    @media (min-width: 768px) {
        .checkout-hero {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 20px;
        }
        
        .checkout-header {
            grid-column: 1 / -1;
        }
        
        .step-indicator {
            grid-column: 1 / -1;
        }
        
        .order-summary-card {
            position: sticky;
            top: 100px;
            align-self: start;
        }
    }
    
    /* Large Desktop (992px and above) */
    @media (min-width: 992px) {
        .checkout-hero {
            grid-template-columns: 1.5fr 1fr;
            gap: 32px;
            padding: 24px;
        }
    }
    
    /* ===== ANIMATIONS ===== */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    
    .animate-slide-right {
        animation: slideInRight 0.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-custom py-3">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="bi bi-house"></i> Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'view_cart' %}">Cart</a></li>
            <li class="breadcrumb-item active" aria-current="page">Checkout</li>
        </ol>
    </nav>

    <!-- Main Checkout Container -->
    <div class="checkout-hero">
        <!-- Header -->
        <div class="checkout-header">
            <h1><i class="bi bi-basket"></i> Complete Your Purchase</h1>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active">
                <div class="step-number">1</div>
                <span class="step-label">Shipping</span>
            </div>
            <div class="step-line active"></div>
            <div class="step">
                <div class="step-number">2</div>
                <span class="step-label">Payment</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-number">3</div>
                <span class="step-label">Confirmation</span>
            </div>
        </div>

        <!-- Left Column: Shipping Form -->
        <div class="form-section">
            <form method="post" id="checkoutForm" novalidate>
                {% csrf_token %}
                
                <h3 class="section-title">
                    <i class="bi bi-truck"></i>
                    Shipping Details
                </h3>
                
                {% if form.non_field_errors %}
                <div class="info-card" style="border-color: var(--danger); background: rgba(234, 67, 53, 0.05);">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-exclamation-triangle text-danger"></i>
                        <div>
                            {% for error in form.non_field_errors %}
                            <p class="mb-0 small">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Alternate Shipping Toggle -->
                <div class="form-switch">
                    <div class="switch-control">
                        <input type="checkbox" class="switch-input" id="useAlternateShipping" name="use_alternate_shipping" {% if use_alternate_shipping %}checked{% endif %}>
                        <span class="switch-slider"></span>
                    </div>
                    <label for="useAlternateShipping" class="switch-label">Use different shipping address</label>
                </div>
                
                <!-- Account Info (Hidden when alternate shipping is checked) -->
                <div id="accountInfo" {% if use_alternate_shipping %}style="display: none;"{% endif %}>
                    <div class="info-card">
                        <h6><i class="bi bi-person-circle"></i> Using Account Details</h6>
                        <div class="row g-2">
                            <div class="col-12">
                                <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
                            </div>
                            <div class="col-12">
                                <small class="text-muted">{{ request.user.email }}</small>
                            </div>
                            {% if request.user.phone_number %}
                            <div class="col-12">
                                <small class="text-muted">{{ request.user.phone_number }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Alternate Shipping Form (Shown when toggle is checked) -->
                <div id="alternateShippingForm" {% if not use_alternate_shipping %}style="display: none;"{% endif %}>
                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name *</label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.first_name.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 form-group">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name *</label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.last_name.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Email *</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.email.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 form-group">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">Phone Number *</label>
                            {{ form.phone_number }}
                            {% if form.phone_number.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.phone_number.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                


                <!-- Shipping Address -->
                <div class="form-group">
                    <div class="mb-3">
                        <label for="{{ form.shipping_address.id_for_label }}" class="form-label">
                            {{ form.shipping_address.label }}
                            {% if form.shipping_address.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.shipping_address|as_crispy_field }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 form-group">
                        <div class="mb-3">
                            <label class="form-label">
                                {{ form.city.label }}
                                {% if form.city.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.city|as_crispy_field }}
                        </div>
                    </div>
                    <div class="col-md-6 form-group">
                        <div class="mb-3">
                            <label for="{{ form.postal_code.id_for_label }}" class="form-label">
                                {{ form.postal_code.label }}
                                {% if form.postal_code.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.postal_code|as_crispy_field }}
                        </div>
                    </div>
                </div>
                
                <!-- Previous Address Button -->
                {% if has_previous_orders %}
                <div class="info-card">
                    <h6><i class="bi bi-clock-history"></i> Use Previous Address?</h6>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn-custom btn-primary btn-sm" id="useLastAddress">
                            <i class="bi bi-check-circle me-1"></i> Use Last Address
                        </button>
                        <button type="button" class="btn-custom btn-ghost btn-sm" id="enterNewAddress">
                            <i class="bi bi-pencil me-1"></i> Enter New
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <!-- Terms Agreement -->
                <div class="info-card">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="terms" required>
                        <label class="form-check-label small" for="terms">
                            I agree to the <a href="#" class="text-primary">Terms of Service</a> and <a href="#" class="text-primary">Privacy Policy</a>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn-checkout" id="placeOrderBtn">
                    <i class="bi bi-lock-fill"></i>
                    Proceed to Payment - KSh {{ cart.get_total_price }}
                </button>
            </form>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="order-summary-card animate-slide-right">
            <div class="summary-header">
                <h3><i class="bi bi-receipt"></i> Order Summary</h3>
            </div>
            
            <div class="summary-content">
                <!-- Order Items -->
                <div class="order-items">
                    {% for item in cart.items.all %}
                    <div class="order-item">
                        <div class="item-image">
                            <img src="{{ item.listing.get_image_url }}" 
                                 alt="{{ item.listing.title }}"
                                 onerror="this.src='https://placehold.co/60x60/c2c2c2/1f1f1f?text=HS'">
                        </div>
                        <div class="item-details">
                            <div class="item-title">{{ item.listing.title|truncatechars:50 }}</div>
                            <div class="item-meta">
                                <span>Qty: {{ item.quantity }}</span>
                                <span class="item-price">KSh {{ item.get_total_price }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Totals -->
                <div class="totals-section">
                    <div class="total-row">
                        <span>Subtotal</span>
                        <span>KSh {{ cart.get_total_price }}</span>
                    </div>
                    <div class="total-row">
                        <span>Shipping</span>
                        <span class="text-success">Free</span>
                    </div>
                    <div class="total-row">
                        <span>Tax</span>
                        <span>KSh 0.00</span>
                    </div>
                    <div class="total-row total">
                        <span>Total</span>
                        <span>KSh {{ cart.get_total_price }}</span>
                    </div>
                </div>
                
                <!-- Security Info -->
                <div class="security-info">
                    <h6><i class="bi bi-shield-check"></i> Secure Checkout</h6>
                    <ul class="security-list">
                        <li><i class="bi bi-check-circle"></i> Encrypted payment</li>
                        <li><i class="bi bi-check-circle"></i> Buyer protection</li>
                        <li><i class="bi bi-check-circle"></i> Escrow service</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="help-card">
        <h6><i class="bi bi-question-circle"></i> Need Help?</h6>
        <div class="help-contact">
            <a href="tel:+254700123456" class="contact-item">
                <i class="bi bi-telephone"></i>
                <span>+254 700 123 456</span>
            </a>
            <a href="mailto:support@baysoko.com" class="contact-item">
                <i class="bi bi-envelope"></i>
                <span>support@baysoko.com</span>
            </a>
            <div class="contact-item">
                <i class="bi bi-clock"></i>
                <span>Mon-Fri: 8:00 AM - 6:00 PM</span>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Checkout page initialized');
        
        // ===== ELEMENT REFERENCES =====
        const checkoutForm = document.getElementById('checkoutForm');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const useAlternateShipping = document.getElementById('useAlternateShipping');
        const accountInfo = document.getElementById('accountInfo');
        const alternateShippingForm = document.getElementById('alternateShippingForm');
        const useLastAddress = document.getElementById('useLastAddress');
        const enterNewAddress = document.getElementById('enterNewAddress');
        const termsCheckbox = document.getElementById('terms');
        const toastContainer = document.getElementById('toastContainer');
        
        // ===== TOAST NOTIFICATION SYSTEM =====
        window.showToast = function(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast animate-fade-in`;
            toast.innerHTML = `
                <div class="toast-body">
                    <i class="bi ${getToastIcon(type)}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add type-specific styling
            if (type === 'success') {
                toast.style.borderLeft = '4px solid var(--success)';
            } else if (type === 'error') {
                toast.style.borderLeft = '4px solid var(--danger)';
            } else if (type === 'warning') {
                toast.style.borderLeft = '4px solid var(--warning)';
            } else {
                toast.style.borderLeft = '4px solid var(--primary)';
            }
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        };
        
        function getToastIcon(type) {
            switch(type) {
                case 'success': return 'bi-check-circle-fill text-success';
                case 'error': return 'bi-exclamation-circle-fill text-danger';
                case 'warning': return 'bi-exclamation-triangle-fill text-warning';
                default: return 'bi-info-circle-fill text-primary';
            }
        }
        
        // ===== ALTERNATE SHIPPING TOGGLE =====
        if (useAlternateShipping) {
            useAlternateShipping.addEventListener('change', function() {
                if (this.checked) {
                    accountInfo.style.display = 'none';
                    alternateShippingForm.style.display = 'block';
                    
                    // Enable all alternate shipping form fields
                    const alternateFields = alternateShippingForm.querySelectorAll('input, select, textarea');
                    alternateFields.forEach(field => {
                        field.disabled = false;
                    });
                } else {
                    accountInfo.style.display = 'block';
                    alternateShippingForm.style.display = 'none';
                    
                    // Disable all alternate shipping form fields
                    const alternateFields = alternateShippingForm.querySelectorAll('input, select, textarea');
                    alternateFields.forEach(field => {
                        field.disabled = true;
                    });
                    
                    // Fill with user's account info
                    fillWithAccountInfo();
                }
            });
            
            // Initialize based on current state
            if (!useAlternateShipping.checked) {
                fillWithAccountInfo();
            }
        }
        
        function fillWithAccountInfo() {
            const firstNameField = document.getElementById('{{ form.first_name.id_for_label }}');
            const lastNameField = document.getElementById('{{ form.last_name.id_for_label }}');
            const emailField = document.getElementById('{{ form.email.id_for_label }}');
            const phoneField = document.getElementById('{{ form.phone_number.id_for_label }}');
            
            if (firstNameField) firstNameField.value = '{{ request.user.first_name|escapejs }}';
            if (lastNameField) lastNameField.value = '{{ request.user.last_name|escapejs }}';
            if (emailField) emailField.value = '{{ request.user.email|escapejs }}';
            if (phoneField) phoneField.value = '{{ request.user.phone_number|default:""|escapejs }}';
        }
        
        // ===== PREVIOUS ADDRESS HANDLING =====
        if (useLastAddress) {
            useLastAddress.addEventListener('click', function() {
                const shippingAddressField = document.getElementById('{{ form.shipping_address.id_for_label }}');
                const cityField = document.getElementById('{{ form.city.id_for_label }}');
                const postalCodeField = document.getElementById('{{ form.postal_code.id_for_label }}');
                
                if (shippingAddressField) shippingAddressField.value = '{{ form.initial.shipping_address|escapejs }}';
                if (cityField) cityField.value = '{{ form.initial.city|escapejs }}';
                if (postalCodeField) postalCodeField.value = '{{ form.initial.postal_code|escapejs }}';
                
                showToast('Previous address loaded', 'success');
            });
        }
        
        if (enterNewAddress) {
            enterNewAddress.addEventListener('click', function() {
                const shippingAddressField = document.getElementById('{{ form.shipping_address.id_for_label }}');
                const cityField = document.getElementById('{{ form.city.id_for_label }}');
                const postalCodeField = document.getElementById('{{ form.postal_code.id_for_label }}');
                
                if (shippingAddressField) {
                    shippingAddressField.value = '';
                    shippingAddressField.focus();
                }
                if (cityField) cityField.value = '';
                if (postalCodeField) postalCodeField.value = '';
                
                showToast('Enter new shipping address', 'info');
            });
        }
        
        // ===== FORM VALIDATION =====
        function validateForm() {
            let isValid = true;
            const requiredFields = [];
            
            // Always require shipping address, city, and postal code
            requiredFields.push(
                '{{ form.shipping_address.id_for_label }}',
                '{{ form.city.id_for_label }}',
                '{{ form.postal_code.id_for_label }}'
            );
            
            // If alternate shipping is checked, also require name, email, phone
            if (useAlternateShipping && useAlternateShipping.checked) {
                requiredFields.push(
                    '{{ form.first_name.id_for_label }}',
                    '{{ form.last_name.id_for_label }}',
                    '{{ form.email.id_for_label }}',
                    '{{ form.phone_number.id_for_label }}'
                );
            }
            
            // Validate each required field
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    const value = field.value.trim();
                    const parent = field.closest('.form-group');
                    
                    if (!value) {
                        field.classList.add('is-invalid');
                        if (parent) {
                            parent.classList.add('has-error');
                        }
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                        if (parent) {
                            parent.classList.remove('has-error');
                        }
                    }
                }
            });
            
            // Validate terms agreement
            if (!termsCheckbox.checked) {
                termsCheckbox.classList.add('is-invalid');
                showToast('Please agree to the terms and conditions', 'error');
                isValid = false;
            } else {
                termsCheckbox.classList.remove('is-invalid');
            }
            
            return isValid;
        }
        
        // ===== FORM SUBMISSION =====
        checkoutForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Show loading state
            const originalText = placeOrderBtn.innerHTML;
            placeOrderBtn.innerHTML = '<i class="bi bi-hourglass-split spin"></i> Processing...';
            placeOrderBtn.disabled = true;
            
            // Disable all form fields to prevent double submission
            const formElements = checkoutForm.elements;
            for (let i = 0; i < formElements.length; i++) {
                formElements[i].disabled = true;
            }
            
            // If alternate shipping is not checked, we need to ensure those fields are not validated
            if (!useAlternateShipping.checked) {
                // Temporarily fill and disable the fields
                fillWithAccountInfo();
                
                // Disable the fields so Django doesn't validate them
                const alternateFields = alternateShippingForm.querySelectorAll('input, select, textarea');
                alternateFields.forEach(field => {
                    field.disabled = true;
                });
            }
            
            // Submit the form
            setTimeout(() => {
                checkoutForm.submit();
            }, 500);
        });
        
        // ===== REAL-TIME VALIDATION =====
        const formInputs = checkoutForm.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
            
            input.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                }
            });
        });
        
        termsCheckbox.addEventListener('change', function() {
            if (this.checked) {
                this.classList.remove('is-invalid');
            }
        });
        
        // ===== INITIALIZATION =====
        function initialize() {
            console.log('Checkout page initialized');
            
            // Add animation to order items
            document.querySelectorAll('.order-item').forEach((item, index) => {
                item.classList.add('animate-fade-in');
                item.style.animationDelay = `${index * 0.1}s`;
            });
            
            // Display any Django messages as toasts
            {% for message in messages %}
            setTimeout(() => {
                showToast('{{ message|escapejs }}', '{{ message.tags }}');
            }, {{ forloop.counter0 }} * 100 + 300);
            {% endfor %}
            
            // Auto-scroll to any invalid fields
            setTimeout(() => {
                const firstInvalid = document.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    firstInvalid.focus();
                }
            }, 500);
        }
        
        // Start initialization
        initialize();
        
        // ===== WINDOW RESIZE HANDLER =====
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Adjust layout for mobile
                if (window.innerWidth < 768) {
                    document.querySelector('.order-summary-card')?.classList.remove('sticky');
                }
            }, 250);
        });
    });
</script>
{% endblock %}