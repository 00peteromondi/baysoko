<!-- templates/chats/inbox.html - UPDATED WITH ALL FIXES -->
{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Messages - Baysoko{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/messaging.css' %}">
<style>
    /* Message bubble animations */
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Message bubble alignment FIXED */
    .messages-container {
        display: flex;
        flex-direction: column;
        padding: 20px;
        gap: 8px;
        min-height: 200px;
    }

    .message-bubble {
        position: relative;
        padding: 10px 16px;
        border-radius: 18px;
        margin: 4px 0;
        max-width: 75%;
        word-wrap: break-word;
        animation: messageAppear 0.3s ease-out;
        box-sizing: border-box;
    }

    /* Received messages - left aligned */
    .message-bubble.received {
        background: #f1f3f4;
        color: #202124;
        border-radius: 18px 18px 18px 4px;
        align-self: flex-start;
        margin-right: auto;
        border: 1px solid #e0e0e0;
        animation: slideInLeft 0.3s ease-out;
    }

    body.dark-mode .message-bubble.received {
        background: #2d3748;
        color: #e2e8f0;
        border-color: #4a5568;
    }

    /* Sent messages - right aligned */
    .message-bubble.sent {
        background: #007bff;
        color: white;
        border-radius: 18px 18px 4px 18px;
        align-self: flex-end;
        margin-left: auto;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* NEW CONVERSATION FLOW IMPROVEMENTS */
    .new-conversation-content {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    body.dark-mode .search-container {
    }
    
    .search-results-container {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .search-results {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }
    
    .search-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 40px 20px;
        text-align: center;
        color: #6c757d;
    }
    
    body.dark-mode .search-placeholder {
        color: #a0aec0;
    }
    
    .search-placeholder i {
        font-size: 48px;
        margin-bottom: 16px;
        color: #dee2e6;
    }
    
    body.dark-mode .search-placeholder i {
        color: #4a5568;
    }
    
    /* Message composer in new conversation */
    .message-composer-container {
        display: flex;
        flex-direction: column;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
    }
    
    body.dark-mode .message-composer-container {
        background: #2d3748;
        border-top-color: #4a5568;
    }
    
    /* User result improvements */
    .user-result {
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid transparent;
    }
    
    .user-result:hover {
        background: #f8f9fa;
        border-color: #dee2e6;
        transform: translateX(5px);
    }
    
    body.dark-mode .user-result:hover {
        background: #4a5568;
        border-color: #718096;
    }
    
    .user-result.selected {
        background: #e3f2fd;
        border-color: #007bff;
    }
    
    body.dark-mode .user-result.selected {
        background: rgba(0, 123, 255, 0.2);
    }

    /* Mobile optimizations for new conversation */
    @media (max-width: 992px) {
        .messaging-container {
            height: calc(100vh - 60px);
            border-radius: 0;
        }
        
        .chat-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light);
            z-index: 1050;
            display: none !important;
            flex-direction: column;
        }
        
        body.dark-mode .chat-panel {
            background: #1a1a1a;
        }
        
        .chat-panel.active {
            display: flex !important;
        }
        
        /* New conversation panel mobile fixes */
        .new-conversation-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light);
            z-index: 1060;
            display: none !important;
            flex-direction: column;
        }
        
        body.dark-mode .new-conversation-panel {
            background: #1a1a1a;
        }
        
        .new-conversation-panel.active {
            display: flex !important;
        }
        
        /* Mobile chat header with safe area */
        .chat-header {
            padding-top: calc(16px + env(safe-area-inset-top));
            padding-left: 16px;
            padding-right: 16px;
            background: var(--light);
            border-bottom: 1px solid #e9ecef;
            min-height: 70px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        body.dark-mode .chat-header {
            background: #1a1a1a;
            border-bottom-color: #2d3748;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Show back button on mobile */
        .chat-header .back-to-list {
            display: flex !important;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            margin-right: 12px;
            background: none;
            border: none;
            color: #333;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        body.dark-mode .chat-header .back-to-list {
            color: #e2e8f0;
        }
        
        .chat-header .back-to-list:hover {
            background: #f5f5f5;
        }
        
        body.dark-mode .chat-header .back-to-list:hover {
            background: #2d3748;
        }
        
        /* Ensure proper scrolling on mobile */
        .messages-container {
            height: calc(100vh - 180px);
            padding-bottom: 80px;
        }
        
        /* Fix message input on mobile */
        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--light);
            border-top: 1px solid #e9ecef;
            padding: 12px 16px;
            z-index: 1051;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        body.dark-mode .chat-input-area {
            background: #1a1a1a;
            border-top-color: #2d3748;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        /* Adjust message bubbles for mobile */
        .message-bubble {
            max-width: 85%;
        }
        
        /* Search results container on mobile */
        .search-results-container {
            height: calc(100vh - 200px);
        }
        
        .search-results {
            padding: 12px;
        }
        
        /* New conversation header on mobile */
        .new-conversation-header {
            padding-top: env(safe-area-inset-top);
            padding-bottom: 16px;
            border-bottom: 1px solid #e9ecef;
            background: var(--light);
            flex-shrink: 0;
        }
        
        body.dark-mode .new-conversation-header {
            background: #1a1a1a;
            border-bottom-color: #2d3748;
        }
        
        /* Mobile-specific improvements for new conversation flow */
        .new-conversation-panel {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .selected-user-info {
            padding: 16px;
            position: sticky;
            bottom: 0;
            background: var(--light);
            z-index: 10;
        }
        
        body.dark-mode .selected-user-info {
            background: #1a1a1a;
        }
    }

    /* Desktop improvements for new conversation */
    @media (min-width: 993px) {
        .new-conversation-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .search-results-container {
            max-height: 300px;
            min-height: 200px;
        }
        
        .message-composer-container {
            flex-shrink: 0;
            padding: 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="messaging-container">
    <!-- Messages Header -->
    <div class="messages-header">
        <div class="messages-header-content">
            <h1><i class="bi bi-chat-dots"></i> Messages</h1>
            <div class="unread-badge" id="globalUnreadBadge" style="display: none;"></div>
        </div>
    </div>

    <!-- Messaging Layout -->
    <div class="messaging-layout">
        <!-- Conversations Panel -->
        <div class="conversations-panel" id="conversationsPanel">
            <div class="conversations-header">
                <div class="conversations-search">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchConversations" placeholder="Search conversations..." autocomplete="off">
                </div>
                
                <div class="conversations-actions">
                    <button class="btn-custom btn-primary" id="newConversationBtn">
                        <i class="bi bi-plus-circle"></i> New Message
                    </button>
                </div>
                
                <!-- Filter Tabs -->
                <div class="conversation-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="unread">
                        <i class="bi bi-circle-fill"></i> Unread
                        <span class="filter-badge" id="unreadFilterBadge" style="display: none;"></span>
                    </button>
                    <button class="filter-btn" data-filter="with-listing">With Listing</button>
                </div>
            </div>

            <!-- Conversations List -->
            <div class="conversations-list mb-4 pb-5" id="conversationsList">
                <!-- Content loaded dynamically -->
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel pb-5" id="chatPanel">
            <!-- New Conversation Panel -->
            <div class="new-conversation-panel" id="newConversationPanel" style="display: none;">
                <div class="new-conversation-header">
                    <button class="back-to-chat" id="backToChatBtn">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <h5>New Message</h5>
                </div>
                
                <div class="new-conversation-content">
                    <!-- Search Section -->
                    <div class="search-container">
                        <div class="recipient-search">
                            <i class="bi bi-search"></i>
                            <input type="text" id="newChatSearch" placeholder="Search users by name or username..." autocomplete="off">
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div class="search-results-container">
                        <div class="search-results" id="searchResults">
                            <div class="search-placeholder">
                                <i class="bi bi-search"></i>
                                <p>Search for users to start a conversation</p>
                                <small class="text-muted mt-2">Type at least 2 characters to search</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Composer (Shown when recipient is selected) -->
                    <div class="message-composer-container" id="selectedUserInfo" style="display: none;">
                        <div class="selected-user-header">
                            <div class="selected-user-details">
                                <img id="selectedUserAvatar" src="" alt="">
                                <div>
                                    <h6 id="selectedUserName"></h6>
                                    <span>Recipient</span>
                                </div>
                            </div>
                            <button class="btn-close" id="clearSelectionBtn" title="Clear selection"></button>
                        </div>
                        
                        <div class="message-composer">
                            <textarea id="newMessageText" placeholder="Type your message..." rows="3" maxlength="1000"></textarea>
                            <div class="composer-actions">
                                <div class="attachment-options">
                                    <button type="button" class="btn-attachment" onclick="messaging.attachFile()">
                                        <i class="bi bi-paperclip"></i>
                                    </button>
                                    <input type="file" id="newFileInput" multiple style="display: none;">
                                </div>
                                <div class="char-count">
                                    <span id="newCharCount">0/1000</span>
                                </div>
                            </div>
                            <button class="btn-send" id="sendNewMessageBtn" disabled>
                                <i class="bi bi-send me-2"></i> Send Message
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty Chat State -->
            <div class="chat-empty-state" id="chatEmptyState">
                <i class="bi bi-chat-left-text"></i>
                <h3>Select a conversation</h3>
                <p>Choose a conversation from the list to start messaging, or start a new conversation.</p>
                <button class="btn-custom btn-primary" id="emptyStateNewChatBtn">
                    <i class="bi bi-plus-circle"></i> New Message
                </button>
            </div>

            <!-- Active Chat -->
            <div class="active-chat" id="activeChat" style="display: none;">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <button class="back-to-list" id="backToListBtn">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <div class="chat-participant-info">
                            <img id="chatParticipantAvatar" src="" alt="">
                            <div class="participant-details">
                                <h5 id="chatParticipantName"></h5>
                                <div class="participant-status">
                                    <span id="chatParticipantStatus">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>
                
                <div class="chat-input-area">
                    <div class="message-form">
                        <div class="message-input-container">
                            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1" maxlength="1000"></textarea>
                            <div class="input-actions">
                                <button type="button" class="btn-attachment" onclick="messaging.attachFile()">
                                    <i class="bi bi-paperclip"></i>
                                </button>
                                <button type="button" class="btn-emoji" onclick="messaging.toggleEmojiPicker()">
                                    <i class="bi bi-emoji-smile"></i>
                                </button>
                            </div>
                        </div>
                        <button class="btn-send" id="sendMessageBtn">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    <div class="message-length-indicator">
                        <span id="messageLength">0/1000</span>
                    </div>
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span id="typingText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Toast Container -->
<div id="messagingErrorContainer" class="messaging-error-container" style="display: none;"></div>

<!-- Loading Overlay -->
<div id="messagingLoadingOverlay" class="messaging-loading-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Hidden elements for state -->
<meta name="user-id" content="{{ request.user.id }}">
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/messaging.js' %}"></script>
<script>
// Prevent duplicate initialization
let messagingSystemInitialized = false;

// Initialize messaging system when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on the messages page
    if (document.getElementById('conversationsList') && !messagingSystemInitialized) {
        // Initialize the messaging system
        if (!window.messaging) {
            window.messaging = new MessagingSystem();
        }
        window.messaging.init();
        messagingSystemInitialized = true;
    }
});

// Handle mobile back button
window.addEventListener('popstate', function(event) {
    if (window.messaging && window.messaging.state.isMobile && window.messaging.state.currentConversationId) {
        window.messaging.closeActiveChat();
        window.history.pushState(null, '', window.location.pathname);
    }
});

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (window.messaging) {
        if (document.hidden) {
            window.messaging.handleTabHidden();
        } else {
            window.messaging.handleTabVisible();
        }
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (window.messaging) {
        window.messaging.cleanup();
        messagingSystemInitialized = false;
    }
});
</script>
{% endblock %}