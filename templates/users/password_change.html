{% extends 'base.html' %}
{% load static %}

{% block title %}Change Password - Baysoko{% endblock %}

{% block extra_css %}
<style>
    /* ===== PASSWORD CHANGE PAGE - MATCHING LISTING_DETAIL ===== */
    .container-custom {
        padding-left: 8px;
        padding-right: 8px;
    }

    /* Breadcrumb */
    .breadcrumb {
        background: var(--bg-secondary);
        padding: 10px 12px;
        border-radius: var(--radius-md);
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        font-size: 12px;
    }

    .breadcrumb-item a {
        text-decoration: none;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
    }

    /* Main Card */
    .password-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        position: relative;
    }

    .password-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    /* Header */
    .password-header {
        padding: 24px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .password-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.8rem;
        flex-shrink: 0;
    }

    .password-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .password-subtitle {
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.4;
    }

    /* Form Container */
    .password-body {
        padding: 24px;
    }

    /* Form Grid - Similar to listing_detail specs */
    .password-form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    @media (min-width: 768px) {
        .password-form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Form Group - Matching listing_detail input styling */
    .form-group-custom {
        margin-bottom: 20px;
    }

    .form-group-custom.full-width {
        grid-column: 1 / -1;
    }

    .form-label-custom {
        display: block;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .input-group-custom {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-custom {
        width: 100%;
        padding: 14px 48px 14px 16px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 1rem;
        color: var(--text-primary);
        transition: all 0.3s ease;
        outline: none;
    }

    .input-custom:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        transform: translateY(-2px);
    }

    .input-custom.error {
        border-color: var(--danger);
    }

    .input-custom.success {
        border-color: var(--success);
    }

    .password-toggle-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-tertiary);
        cursor: pointer;
        font-size: 1.1rem;
        padding: 4px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .password-toggle-btn:hover {
        background: var(--bg-secondary);
        color: var(--primary);
    }

    /* Password Strength Meter - Matching listing_detail badge styling */
    .strength-container {
        margin-top: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border: 1px solid var(--border-color);
        animation: fadeIn 0.3s ease-out;
    }

    .strength-meter {
        height: 6px;
        background: var(--border-color);
        border-radius: 3px;
        margin-bottom: 8px;
        overflow: hidden;
    }

    .strength-fill {
        height: 100%;
        border-radius: 3px;
        transition: all 0.3s ease;
    }

    .strength-text {
        font-size: 0.85rem;
        font-weight: 700;
        text-align: center;
        transition: color 0.3s ease;
    }

    /* Strength colors matching listing_detail badges */
    .strength-weak { 
        background: linear-gradient(135deg, var(--danger) 0%, #d12a4e 100%);
        width: 25%; 
    }
    .strength-fair { 
        background: linear-gradient(135deg, var(--warning) 0%, #ff9a3c 100%);
        width: 50%; 
    }
    .strength-good { 
        background: linear-gradient(135deg, var(--info) 0%, #3d8bfd 100%);
        width: 75%; 
    }
    .strength-strong { 
        background: linear-gradient(135deg, var(--success) 0%, var(--accent-dark) 100%);
        width: 100%; 
    }

    /* Password Match Indicator */
    .match-indicator {
        margin-top: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 14px;
        border-radius: 10px;
        animation: fadeIn 0.3s ease-out;
    }

    .match-indicator.matching {
        background: rgba(var(--success-rgb), 0.1);
        border: 1px solid rgba(var(--success-rgb), 0.2);
        color: var(--success);
    }

    .match-indicator.not-matching {
        background: rgba(var(--danger-rgb), 0.1);
        border: 1px solid rgba(var(--danger-rgb), 0.2);
        color: var(--danger);
    }

    /* Action Buttons - Matching listing_detail buttons */
    .action-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
    }

    @media (max-width: 576px) {
        .action-buttons {
            grid-template-columns: 1fr;
        }
    }

    .btn-custom {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .btn-custom.btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-custom.btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-custom.btn-ghost {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }

    .btn-custom.btn-ghost:hover {
        background: var(--bg-secondary);
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-custom:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Info Card - Similar to listing_detail info cards */
    .info-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        margin-top: 24px;
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .info-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .info-card h5 {
        margin-bottom: 12px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        font-weight: 700;
    }

    .info-card p {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .password-header {
            padding: 20px;
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }

        .password-icon {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }

        .password-title {
            font-size: 1.3rem;
        }

        .password-body {
            padding: 20px;
        }

        .password-form-grid {
            gap: 16px;
        }
    }

    @media (max-width: 576px) {
        .password-card {
            border-radius: 12px;
        }

        .password-header {
            padding: 16px;
        }

        .password-body {
            padding: 16px;
        }

        .input-custom {
            padding: 12px 44px 12px 12px;
            font-size: 0.95rem;
        }

        .btn-custom {
            padding: 12px 20px;
            font-size: 0.95rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-custom py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="bi bi-house"></i> Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'profile' user.pk %}"><i class="bi bi-person"></i> Profile</a></li>
            <li class="breadcrumb-item active" aria-current="page">Change Password</li>
        </ol>
    </nav>

    <!-- Main Password Card -->
    <div class="password-card">
        <!-- Header -->
        <div class="password-header">
            <div class="password-icon">
                <i class="bi bi-shield-lock"></i>
            </div>
            <div>
                <h1 class="password-title">Change Password</h1>
                <p class="password-subtitle">
                    Update your password to keep your Baysoko account secure and protected.
                </p>
            </div>
        </div>

        <!-- Body -->
        <div class="password-body">
            <!-- Include AJAX password change section -->
            {% include 'users/profile-change/profile_password_change_section.html' %}

            <!-- Alternative Regular Form -->
            <form method="post" novalidate id="passwordChangeForm" style="display: none;">
                {% csrf_token %}
                
                <div class="password-form-grid">
                    <!-- Current Password -->
                    <div class="form-group-custom full-width">
                        <label class="form-label-custom" for="id_old_password">
                            <i class="bi bi-key-fill"></i>
                            Current Password <span class="text-danger">*</span>
                        </label>
                        <div class="input-group-custom">
                            <input type="password" 
                                   name="old_password" 
                                   class="input-custom" 
                                   id="id_old_password" 
                                   placeholder="Enter your current password"
                                   required>
                            <button type="button" class="password-toggle-btn" data-target="id_old_password">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- New Password -->
                    <div class="form-group-custom">
                        <label class="form-label-custom" for="id_new_password1">
                            <i class="bi bi-lock"></i>
                            New Password <span class="text-danger">*</span>
                        </label>
                        <div class="input-group-custom">
                            <input type="password" 
                                   name="new_password1" 
                                   class="input-custom" 
                                   id="id_new_password1" 
                                   placeholder="Create new password"
                                   required>
                            <button type="button" class="password-toggle-btn" data-target="id_new_password1">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <!-- Password Strength -->
                        <div class="strength-container" id="strengthContainer" style="display: none;">
                            <div class="strength-meter">
                                <div class="strength-fill" id="strengthFill"></div>
                            </div>
                            <div class="strength-text" id="strengthText">Password strength</div>
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div class="form-group-custom">
                        <label class="form-label-custom" for="id_new_password2">
                            <i class="bi bi-lock-fill"></i>
                            Confirm Password <span class="text-danger">*</span>
                        </label>
                        <div class="input-group-custom">
                            <input type="password" 
                                   name="new_password2" 
                                   class="input-custom" 
                                   id="id_new_password2" 
                                   placeholder="Confirm new password"
                                   required>
                            <button type="button" class="password-toggle-btn" data-target="id_new_password2">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <!-- Password Match -->
                        <div class="match-indicator" id="matchIndicator" style="display: none;">
                            <i class="bi bi-check-circle"></i>
                            <span>Passwords match</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="submit" class="btn-custom btn-primary" id="submitBtn">
                        <i class="bi bi-check-circle"></i>
                        Update Password
                    </button>
                    <a href="{% url 'profile' user.pk %}" class="btn-custom btn-ghost">
                        <i class="bi bi-arrow-left"></i>
                        Back to Profile
                    </a>
                </div>
            </form>

            <!-- Security Info Card -->
            <div class="info-card">
                <h5><i class="bi bi-shield-check"></i> Password Requirements</h5>
                <p>• Minimum 8 characters<br>
                   • Include uppercase and lowercase letters<br>
                   • Add numbers or special characters for extra security<br>
                   • Don't reuse old passwords</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password toggle functionality
    const passwordToggles = document.querySelectorAll('.password-toggle-btn');
    passwordToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (passwordInput && icon) {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                icon.classList.toggle('bi-eye');
                icon.classList.toggle('bi-eye-slash');
            }
        });
    });

    // Password strength meter (for regular form)
    const passwordInput = document.getElementById('id_new_password1');
    const strengthContainer = document.getElementById('strengthContainer');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    if (passwordInput && strengthContainer && strengthFill && strengthText) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            
            if (password.length === 0) {
                strengthContainer.style.display = 'none';
                return;
            }
            
            let strength = 0;
            let checks = [];
            
            // Length check
            if (password.length >= 8) {
                strength += 25;
                checks.push('length');
            }
            
            // Lowercase check
            if (/[a-z]/.test(password)) {
                strength += 25;
                checks.push('lowercase');
            }
            
            // Uppercase check
            if (/[A-Z]/.test(password)) {
                strength += 25;
                checks.push('uppercase');
            }
            
            // Number/Special char check
            if (/[0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                strength += 25;
                checks.push('special');
            }
            
            // Show strength meter
            strengthContainer.style.display = 'block';
            
            // Update strength meter
            strengthFill.className = 'strength-fill';
            
            if (strength <= 25) {
                strengthFill.classList.add('strength-weak');
                strengthText.textContent = 'Weak password';
                strengthText.style.color = 'var(--danger)';
            } else if (strength <= 50) {
                strengthFill.classList.add('strength-fair');
                strengthText.textContent = 'Fair password';
                strengthText.style.color = 'var(--warning)';
            } else if (strength <= 75) {
                strengthFill.classList.add('strength-good');
                strengthText.textContent = 'Good password';
                strengthText.style.color = 'var(--info)';
            } else {
                strengthFill.classList.add('strength-strong');
                strengthText.textContent = 'Strong password';
                strengthText.style.color = 'var(--success)';
            }
        });
    }

    // Password match check (for regular form)
    const password1Input = document.getElementById('id_new_password1');
    const password2Input = document.getElementById('id_new_password2');
    const matchIndicator = document.getElementById('matchIndicator');
    
    function checkPasswordMatch() {
        if (password1Input && password2Input && matchIndicator) {
            const password1 = password1Input.value;
            const password2 = password2Input.value;
            
            if (password2.length === 0) {
                matchIndicator.style.display = 'none';
                password2Input.classList.remove('error', 'success');
                return;
            }
            
            if (password1 === password2) {
                matchIndicator.style.display = 'flex';
                matchIndicator.className = 'match-indicator matching';
                matchIndicator.innerHTML = '<i class="bi bi-check-circle"></i><span>Passwords match</span>';
                password2Input.classList.remove('error');
                password2Input.classList.add('success');
            } else {
                matchIndicator.style.display = 'flex';
                matchIndicator.className = 'match-indicator not-matching';
                matchIndicator.innerHTML = '<i class="bi bi-x-circle"></i><span>Passwords do not match</span>';
                password2Input.classList.remove('success');
                password2Input.classList.add('error');
            }
        }
    }
    
    if (password1Input && password2Input) {
        password1Input.addEventListener('input', checkPasswordMatch);
        password2Input.addEventListener('input', checkPasswordMatch);
    }

    // Form submission handling (for regular form)
    const form = document.getElementById('passwordChangeForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password1 = password1Input?.value || '';
            const password2 = password2Input?.value || '';
            const oldPassword = document.getElementById('id_old_password')?.value || '';
            
            // Validation
            if (!oldPassword) {
                showMessage('Please enter your current password', 'error');
                return;
            }
            
            if (password1.length < 8) {
                showMessage('Password must be at least 8 characters long', 'error');
                return;
            }
            
            if (password1 !== password2) {
                showMessage('Passwords do not match', 'error');
                return;
            }
            
            // Show loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i> Updating...';
            submitBtn.disabled = true;
            
            // Submit form after validation
            setTimeout(() => {
                form.submit();
            }, 1000);
            
            // Re-enable after 5 seconds (in case of error)
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 5000);
        });
    }
    
    // Helper function to show messages
    function showMessage(message, type) {
        // You can implement a toast notification system here
        // For now, using alert as fallback
        alert(message);
    }
    
    // Add spin animation
    const style = document.createElement('style');
    style.textContent = `
        .spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}