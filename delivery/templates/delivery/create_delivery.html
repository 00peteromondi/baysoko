{% extends 'delivery/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Create New Delivery - Delivery Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Delivery</h3>
                <p class="text-muted mb-0">Fill in the delivery details below</p>
            </div>
            <div class="card-body">
                <form method="post" id="deliveryForm">
                    {% csrf_token %}
                    
                    <!-- Order Information -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-shopping-cart me-2"></i>Order Information
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.order_id|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.priority|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pickup Information -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-warehouse me-2"></i>Pickup Information
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.pickup_name|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.pickup_phone|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.pickup_email|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.pickup_latitude|as_crispy_field }}
                            </div>
                        </div>
                        {{ form.pickup_address|as_crispy_field }}
                        {{ form.pickup_notes|as_crispy_field }}
                    </div>
                    
                    <!-- Delivery Information -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-home me-2"></i>Delivery Information
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.recipient_name|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.recipient_phone|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.recipient_email|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.recipient_latitude|as_crispy_field }}
                            </div>
                        </div>
                        {{ form.recipient_address|as_crispy_field }}
                    </div>
                    
                    <!-- Package Information -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-box me-2"></i>Package Information
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.package_weight|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.declared_value|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.package_length|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.package_width|as_crispy_field }}
                            </div>
                        </div>
                        {{ form.package_height|as_crispy_field }}
                        {{ form.package_description|as_crispy_field }}
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.is_fragile }}
                                    <label class="form-check-label" for="{{ form.is_fragile.id_for_label }}">
                                        {{ form.is_fragile.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.requires_signature }}
                                    <label class="form-check-label" for="{{ form.requires_signature.id_for_label }}">
                                        {{ form.requires_signature.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Information -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-truck me-2"></i>Service Information
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.delivery_service|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.delivery_zone|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.estimated_delivery_time|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Additional Information
                        </h5>
                        {{ form.notes|as_crispy_field }}
                    </div>
                    
                    <!-- Pricing Preview -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">Pricing Preview</h6>
                            <div id="pricePreview">
                                <p class="text-muted">Fill in package weight and service to see pricing</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'delivery:dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-delivery">
                            <i class="fas fa-check"></i> Create Delivery
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Quick Help -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Quick Help</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Required Fields</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-asterisk text-danger me-1"></i> Order ID</li>
                            <li><i class="fas fa-asterisk text-danger me-1"></i> Recipient Name & Phone</li>
                            <li><i class="fas fa-asterisk text-danger me-1"></i> Package Weight</li>
                            <li><i class="fas fa-asterisk text-danger me-1"></i> Pickup Information</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Tips</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-lightbulb text-warning me-1"></i> Add coordinates for accurate distance calculation</li>
                            <li><i class="fas fa-lightbulb text-warning me-1"></i> Mark fragile items to ensure careful handling</li>
                            <li><i class="fas fa-lightbulb text-warning me-1"></i> Set realistic delivery estimates</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Calculate delivery fee on form change
    function calculateFee() {
        const weight = parseFloat(document.getElementById('id_package_weight').value) || 0;
        const service = document.getElementById('id_delivery_service').value;
        const zone = document.getElementById('id_delivery_zone').value;
        
        if (weight > 0 && service) {
            fetch('/delivery/api/calculate-fee/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    weight: weight,
                    service_id: service,
                    zone_id: zone
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.delivery_fee) {
                    document.getElementById('pricePreview').innerHTML = `
                        <table class="table table-sm">
                            <tr>
                                <td>Base Fee:</td>
                                <td class="text-end">KES ${data.delivery_fee}</td>
                            </tr>
                            <tr class="table-active">
                                <th>Total Estimated:</th>
                                <th class="text-end">KES ${data.delivery_fee}</th>
                            </tr>
                        </table>
                    `;
                }
            })
            .catch(error => {
                console.error('Error calculating fee:', error);
            });
        }
    }
    
    // Add event listeners for fee calculation
    document.getElementById('id_package_weight').addEventListener('change', calculateFee);
    document.getElementById('id_delivery_service').addEventListener('change', calculateFee);
    document.getElementById('id_delivery_zone').addEventListener('change', calculateFee);
    
    // Form validation
    document.getElementById('deliveryForm').addEventListener('submit', function(e) {
        const weight = parseFloat(document.getElementById('id_package_weight').value);
        if (weight <= 0 || weight > 100) {
            e.preventDefault();
            alert('Package weight must be between 0.1 and 100 kg');
            return false;
        }
    });
</script>
{% endblock %}
{% endblock %}