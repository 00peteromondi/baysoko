{% extends 'base.html' %}
{% load static humanize math_extras number_filters subscription_tags %}

{% block title %}Manage Subscription - {{ store.name }} - Baysoko{% endblock %}

{% block extra_css %}
<style>
    /* ===== GLOBAL CONTAINER ===== */
    .subscription-manage-container {
        min-height: 80vh;
        padding: var(--spacing-xl) 0;
        background: linear-gradient(135deg, 
            rgba(6, 214, 160, 0.05) 0%, 
            rgba(66, 133, 244, 0.05) 50%, 
            rgba(255, 209, 102, 0.05) 100%);
    }

    .container-custom {
        padding-left: 12px;
        padding-right: 12px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* ===== BREADCRUMB ===== */
    .breadcrumb {
        background: var(--bg-secondary);
        padding: 10px 15px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        font-size: 13px;
    }

    .breadcrumb-item a {
        text-decoration: none;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* ===== SUBSCRIPTION HERO ===== */
    .subscription-hero {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
        position: relative;
    }

    .hero-cover {
        position: relative;
        height: 140px;
        overflow: hidden;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }

    .hero-cover-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 25px;
        color: white;
    }

    .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 18px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .hero-info {
        padding: 25px;
        background: var(--card-bg);
    }

    .hero-title {
        font-size: 24px;
        font-weight: 900;
        margin-bottom: 8px;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .hero-subtitle {
        color: var(--text-secondary);
        font-size: 15px;
        margin-bottom: 0;
        line-height: 1.5;
        max-width: 600px;
    }

    /* ===== STATUS CARDS ===== */
    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 25px 0;
    }

    .status-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .status-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, var(--primary), var(--accent));
    }

    .status-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }

    .status-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .status-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
    }

    .status-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-value {
        font-size: 28px;
        font-weight: 900;
        color: var(--text-primary);
        line-height: 1;
        margin-bottom: 5px;
    }

    .status-subtext {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* ===== SECTION STYLES ===== */
    .subscription-section {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 25px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
    }

    .section-title {
        font-size: 18px;
        font-weight: 900;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* ===== FEATURES GRID ===== */
    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin: 20px 0;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .feature-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .feature-item i {
        color: var(--success);
        font-size: 16px;
        flex-shrink: 0;
    }

    .feature-text {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.4;
    }

    /* ===== PLAN CARDS ===== */
    .plan-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .plan-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: 25px;
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .plan-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .plan-card.popular {
        border-color: var(--warning);
        background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(255, 193, 7, 0.05) 100%);
    }

    .plan-card.popular::before {
        content: 'Most Popular';
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--warning);
        color: black;
        padding: 4px 16px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: var(--shadow-sm);
    }

    .plan-card-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .plan-card-title {
        font-size: 18px;
        font-weight: 900;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .plan-card-price {
        font-size: 36px;
        font-weight: 900;
        color: var(--primary);
        line-height: 1;
        margin: 10px 0;
    }

    .plan-card-period {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .plan-card-features {
        list-style: none;
        padding: 0;
        margin: 20px 0;
        flex-grow: 1;
    }

    .plan-card-features li {
        padding: 6px 0;
        color: var(--text-primary);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .plan-card-features li i {
        color: var(--success);
        font-size: 14px;
    }

    /* ===== ACTION BUTTONS ===== */
    .action-buttons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .action-button {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        text-decoration: none;
        color: var(--text-primary);
        cursor: pointer;
        display: block;
    }

    .action-button:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
        text-decoration: none;
        color: var(--text-primary);
        border-color: var(--primary);
    }

    .action-button:disabled,
    .action-button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
        border-color: var(--border-color) !important;
    }

    .action-button-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-color: var(--primary);
    }

    .action-button-primary:hover:not(:disabled) {
        color: white;
        box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
    }

    .action-button-warning {
        background: linear-gradient(135deg, var(--warning) 0%, #e6a900 100%);
        color: black;
        border-color: var(--warning);
    }

    .action-button-warning:hover:not(:disabled) {
        color: black;
        box-shadow: 0 10px 25px rgba(255, 158, 31, 0.3);
    }

    .action-button-danger {
        background: linear-gradient(135deg, var(--danger) 0%, #d12a4e 100%);
        color: white;
        border-color: var(--danger);
    }

    .action-button-danger:hover:not(:disabled) {
        color: white;
        box-shadow: 0 10px 25px rgba(239, 71, 111, 0.3);
    }

    .action-button-ghost {
        background: transparent;
        border: 1px solid var(--border-color);
    }

    .action-button-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-bottom: 15px;
        background: var(--bg-secondary);
        color: var(--primary);
    }

    .action-button-primary .action-button-icon {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .action-button-title {
        font-size: 16px;
        font-weight: 900;
        margin-bottom: 8px;
    }

    .action-button-description {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 0;
        line-height: 1.5;
    }

    /* ===== ALERTS ===== */
    .alert-modern {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        border: 1px solid;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .alert-modern::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
    }

    .alert-modern.alert-warning {
        background: linear-gradient(135deg, rgba(255, 158, 31, 0.05) 0%, rgba(255, 209, 102, 0.05) 100%);
        border-color: var(--warning);
        color: var(--warning-dark);
    }

    .alert-modern.alert-warning::before {
        background: var(--warning);
    }

    .alert-modern.alert-danger {
        background: linear-gradient(135deg, rgba(239, 71, 111, 0.05) 0%, rgba(255, 107, 53, 0.05) 100%);
        border-color: var(--danger);
        color: var(--danger-dark);
    }

    .alert-modern.alert-danger::before {
        background: var(--danger);
    }

    .alert-modern.alert-success {
        background: linear-gradient(135deg, rgba(6, 214, 160, 0.05) 0%, rgba(66, 133, 244, 0.05) 100%);
        border-color: var(--success);
        color: var(--success-dark);
    }

    .alert-modern.alert-success::before {
        background: var(--success);
    }

    .alert-modern.alert-info {
        background: linear-gradient(135deg, rgba(66, 133, 244, 0.05) 0%, rgba(6, 214, 160, 0.05) 100%);
        border-color: var(--info);
        color: var(--info-dark);
    }

    .alert-modern.alert-info::before {
        background: var(--info);
    }

    .alert-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
    }

    .alert-icon {
        font-size: 20px;
    }

    .alert-title {
        font-size: 16px;
        font-weight: 900;
        margin: 0;
    }

    .alert-content {
        font-size: 14px;
        line-height: 1.6;
        margin: 0;
        color: var(--text-secondary);
    }

    /* ===== PAYMENT TABLE ===== */
    .payment-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card-bg);
        border-radius: var(--radius-md);
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .payment-table thead {
        background: var(--bg-secondary);
    }

    .payment-table th {
        padding: 15px;
        text-align: left;
        font-weight: 700;
        color: var(--text-primary);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--border-color);
    }

    .payment-table td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
        font-size: 14px;
    }

    .payment-table tr:last-child td {
        border-bottom: none;
    }

    .payment-table tr:hover {
        background: var(--bg-secondary);
    }

    .payment-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
    }

    .payment-status-success {
        background: rgba(6, 214, 160, 0.1);
        color: var(--success);
        border: 1px solid rgba(6, 214, 160, 0.2);
    }

    .payment-status-warning {
        background: rgba(255, 158, 31, 0.1);
        color: var(--warning);
        border: 1px solid rgba(255, 158, 31, 0.2);
    }

    .payment-status-danger {
        background: rgba(239, 71, 111, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 71, 111, 0.2);
    }

    /* ===== TRIAL PROGRESS ===== */
    .trial-progress-container {
        margin: 20px 0;
    }

    .trial-progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 13px;
    }

    .trial-progress {
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        overflow: hidden;
    }

    .trial-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--success), var(--accent));
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .trial-count-display {
        text-align: center;
        padding: 20px;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
    }

    .trial-count {
        font-size: 48px;
        font-weight: 900;
        color: var(--primary);
        line-height: 1;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
        .container-custom {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .hero-cover {
            height: 120px;
        }
        
        .hero-cover-content {
            padding: 0 15px;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            gap: 10px;
        }
        
        .status-grid {
            grid-template-columns: 1fr;
        }
        
        .features-grid {
            grid-template-columns: 1fr;
        }
        
        .plan-cards {
            grid-template-columns: 1fr;
        }
        
        .action-buttons-grid {
            grid-template-columns: 1fr;
        }
        
        .payment-table {
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }

    @media (max-width: 480px) {
        .subscription-section {
            padding: 15px;
        }
        
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .plan-card {
            padding: 20px;
        }
        
        .plan-card-price {
            font-size: 32px;
        }
    }
</style>
{% endblock %}

{% block content %}
{% with current_plan=subscription.plan|default:'free' %}
<div class="subscription-manage-container">
    <div class="container-custom py-3">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="bi bi-house"></i> Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'storefront:seller_dashboard' %}">Seller Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'storefront:store_detail' store.slug %}">{{ store.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">Manage Subscription</li>
            </ol>
        </nav>

        <!-- Alerts Section -->
        {% if limit_reached %}
        <div class="alert-modern alert-warning animate-fade-in">
            <div class="alert-header">
                <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                <h5 class="alert-title">Free Listing Limit Reached</h5>
            </div>
            <p class="alert-content mb-3">
                You've created {{ current_count }} of {{ free_limit }} free listings.
                Upgrade to premium for unlimited listings and advanced features.
            </p>
            <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-warning btn-sm">
                <i class="bi bi-arrow-up-circle me-2"></i>Upgrade Now
            </a>
        </div>
        {% endif %}

        {% if requested_feature and upgrade_message %}
        <div class="alert-modern alert-warning animate-fade-in">
            <div class="alert-header">
                <i class="bi bi-lock-fill alert-icon"></i>
                <h5 class="alert-title">Premium Feature Required</h5>
            </div>
            <p class="alert-content mb-3">{{ upgrade_message }}</p>
            <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-warning">
                <i class="bi bi-arrow-up-circle me-2"></i>Upgrade Now
            </a>
        </div>
        {% endif %}

        <!-- Action Required Messages -->
        {% if action_required == 'no_subscription' %}
        <div class="alert-modern alert-info animate-fade-in">
            <div class="alert-header">
                <i class="bi bi-info-circle-fill alert-icon"></i>
                <h5 class="alert-title">Free Plan Active</h5>
            </div>
            <p class="alert-content mb-3">
                You're currently on the Free plan with limited features.
                Upgrade to unlock premium features and increase your limits.
            </p>
            <div class="d-flex gap-2 flex-wrap">
                {% if trial_available %}
                <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-secondary">
                    <i class="bi bi-gem me-2"></i>Start Free Trial
                </a>
                {% endif %}
                <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-primary">
                    <i class="bi bi-arrow-up-circle me-2"></i>Upgrade Plan
                </a>
            </div>
        </div>
        {% elif action_required == 'trial_expired' %}
        <div class="alert-modern alert-warning animate-fade-in">
            <div class="alert-header">
                <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                <h5 class="alert-title">Trial Expired</h5>
            </div>
            <p class="alert-content mb-3">
                Your trial period has ended. You've been automatically downgraded to the Free plan.
            </p>
            <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-warning">
                <i class="bi bi-arrow-up-circle me-2"></i>Subscribe Now
            </a>
        </div>
        {% elif action_required == 'past_due' %}
        <div class="alert-modern alert-danger animate-fade-in">
            <div class="alert-header">
                <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                <h5 class="alert-title">Payment Overdue</h5>
            </div>
            <p class="alert-content mb-3">
                Your subscription payment is overdue. Please update your payment to restore premium features.
            </p>
            <a href="{% url 'storefront:subscription_renew' store.slug %}" class="btn-custom btn-danger">
                <i class="bi bi-arrow-clockwise me-2"></i>Update Payment
            </a>
        </div>
        {% elif action_required == 'renew' %}
        <div class="alert-modern alert-info animate-fade-in">
            <div class="alert-header">
                <i class="bi bi-arrow-clockwise alert-icon"></i>
                <h5 class="alert-title">Subscription Ended</h5>
            </div>
            <p class="alert-content mb-3">
                Your subscription has ended. Renew now to restore premium features.
            </p>
            <a href="{% url 'storefront:subscription_renew' store.slug %}" class="btn-custom btn-primary">
                <i class="bi bi-arrow-clockwise me-2"></i>Renew Subscription
            </a>
        </div>
        {% endif %}

        <!-- Subscription Hero -->
        <div class="subscription-hero animate-slide-up">
            <div class="hero-cover">
                <div class="hero-cover-content">
                    <div>
                        <h3 class="fw-bold mb-1">
                            <i class="bi bi-award me-2"></i>
                            {{ current_plan|title }} Plan
                        </h3>
                        <p class="mb-0">Manage your plan, payments, and features</p>
                    </div>
                    <span class="hero-badge">
                        <i class="bi bi-{% if current_plan != 'free' %}star-fill{% else %}star{% endif %}"></i>
                        {{ current_plan|title }} Plan
                    </span>
                </div>
            </div>

            <div class="hero-info">
                <h1 class="hero-title">Manage Your Subscription</h1>
                <p class="hero-subtitle">
                    View your subscription details, payment history, and manage premium features
                </p>

                {% if trial_status_message %}
                <div class="alert-modern alert-info mt-3 animate-fade-in" role="status">
                    <div class="alert-header">
                        <i class="bi bi-gem alert-icon"></i>
                        <h5 class="alert-title">{{ trial_status_message }}</h5>
                    </div>
                    {% if trial_days_remaining is not None %}
                    <p class="alert-content mb-0">{{ trial_days_remaining }} day{{ trial_days_remaining|pluralize }} remaining.</p>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Status Grid -->
                <div class="status-grid">
                    <!-- Current Status -->
                    <div class="status-card animate-fade-in" style="animation-delay: 0.1s;">
                        <div class="status-card-header">
                            <div class="status-icon">
                                <i class="bi 
                                    {% if is_active %}bi-check-circle-fill text-success
                                    {% elif is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}bi-clock-fill text-info
                                    {% elif subscription.trial_ends_at and subscription.trial_ends_at < now %}bi-x-circle-fill text-secondary
                                    {% elif subscription.status == 'past_due' %}bi-exclamation-triangle-fill text-warning
                                    {% else %}bi-x-circle-fill text-secondary{% endif %}">
                                </i>
                            </div>
                            <h4 class="status-title">Current Status</h4>
                        </div>
                        <div class="status-value">
                            {% if is_active %}
                                Active
                            {% elif is_trialing %}
                                {% if subscription.trial_ends_at and subscription.trial_ends_at < now %}
                                    Trial Expired
                                {% else %}
                                    Trial Active
                                {% endif %}
                            {% elif subscription.status == 'past_due' %}
                                Payment Overdue
                            {% elif subscription.status == 'canceled' %}
                                Canceled
                            {% else %}
                                Free Plan
                            {% endif %}
                        </div>
                        <p class="status-subtext">
                            <i class="bi 
                                {% if is_active %}bi-calendar-check text-success
                                {% elif is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}bi-gem text-info
                                {% else %}bi-gift text-secondary{% endif %}">
                            </i>
                            {% if is_active %}
                                Active since {{ subscription.started_at|date:"M d, Y" }}
                            {% elif is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}
                                Trial ends {{ subscription.trial_ends_at|date:"M d, Y" }}
                            {% else %}
                                Free plan with basic features
                            {% endif %}
                        </p>
                    </div>

                    <!-- Monthly Amount -->
                    <div class="status-card animate-fade-in" style="animation-delay: 0.2s;">
                        <div class="status-card-header">
                            <div class="status-icon">
                                <i class="bi bi-credit-card-fill {% if current_plan != 'free' %}text-success{% else %}text-secondary{% endif %}"></i>
                            </div>
                            <h4 class="status-title">Monthly Amount</h4>
                        </div>
                        <div class="status-value">
                            {% if current_plan != 'free' %}
                                KSh {{ subscription.amount|intcomma }}
                            {% else %}
                                Free
                            {% endif %}
                        </div>
                        <p class="status-subtext">
                            <i class="bi 
                                {% if is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}bi-gem text-info
                                {% elif current_plan != 'free' %}bi-calendar-event text-primary
                                {% else %}bi-gift text-secondary{% endif %}">
                            </i>
                            {% if is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}
                                Free during trial
                            {% elif current_plan != 'free' %}
                                Billed monthly
                            {% else %}
                                No charges
                            {% endif %}
                        </p>
                    </div>

                    <!-- Billing Period -->
                    <div class="status-card animate-fade-in" style="animation-delay: 0.3s;">
                        <div class="status-card-header">
                            <div class="status-icon">
                                <i class="bi bi-calendar-fill {% if is_active or is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}text-success{% else %}text-secondary{% endif %}"></i>
                            </div>
                            <h4 class="status-title">Billing Period</h4>
                        </div>
                        <div class="status-value">
                            {% if is_trialing and not trial_expired and subscription.trial_ends_at %}
                                {{ subscription.trial_ends_at|date:"M d" }}
                            {% elif is_active and subscription.current_period_end %}
                                {{ subscription.current_period_end|date:"M d" }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                        <p class="status-subtext">
                            <i class="bi bi-calendar-check"></i>
                            {% if is_trialing and not trial_expired and subscription.trial_ends_at %}
                                Trial ends
                            {% elif is_active and subscription.current_period_end %}
                                Next billing
                            {% else %}
                                No active billing
                            {% endif %}
                        </p>
                    </div>

                    <!-- Store Status -->
                    <div class="status-card animate-fade-in" style="animation-delay: 0.4s;">
                        <div class="status-card-header">
                            <div class="status-icon">
                                <i class="bi bi-shop {% if store.is_premium %}text-success{% else %}text-secondary{% endif %}"></i>
                            </div>
                            <h4 class="status-title">Store Status</h4>
                        </div>
                        <div class="status-value">
                            {% if store.is_premium %}
                                Premium
                            {% else %}
                                Basic
                            {% endif %}
                        </div>
                        <p class="status-subtext">
                            <i class="bi {% if store.is_premium %}bi-check-circle-fill text-success{% else %}bi-info-circle text-secondary{% endif %}"></i>
                            {% if store.is_premium %}
                                Premium features active
                            {% else %}
                                Basic features only
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Subscription Details -->
        <div class="subscription-section animate-scale-in">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-card-checklist"></i>
                    Current Plan Details
                </h2>
                <span class="badge bg-{% if is_active %}success{% elif is_trialing and not trial_expired %}info{% elif subscription.status == 'past_due' %}warning{% else %}secondary{% endif %} bg-opacity-10 text-{% if is_active %}success{% elif is_trialing and not trial_expired %}info{% elif subscription.status == 'past_due' %}warning{% else %}secondary{% endif %} border border-{% if is_active %}success{% elif is_trialing and not trial_expired %}info{% elif subscription.status == 'past_due' %}warning{% else %}secondary{% endif %} border-opacity-25 px-3 py-2">
                    {{ current_plan|title }} Plan
                </span>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="features-grid">
                        {% for feature in plan_details|get_item:current_plan|get_item:'features' %}
                        <div class="feature-item">
                            <i class="bi bi-check-circle-fill"></i>
                            <p class="feature-text">{{ feature }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="status-card h-100">
                        <div class="text-center">
                            <h6 class="text-muted mb-3">Plan Overview</h6>
                            <div class="display-6 fw-bold text-primary mb-3">
                                {% if is_paid_plan %}
                                    KSh {{ subscription.amount|intcomma }}
                                {% else %}
                                    Free
                                {% endif %}
                            </div>
                            <p class="text-muted mb-4">
                                {% if is_paid_plan %}
                                    per month, billed monthly
                                {% else %}
                                    no charges
                                {% endif %}
                            </p>
                            <div class="d-grid gap-2">
                                {% if current_plan != 'free' and is_active %}
                                    <a href="{% url 'storefront:subscription_change_plan' store.slug %}" class="btn-custom btn-outline-primary">
                                        <i class="bi bi-arrow-left-right me-2"></i>Change Plan
                                    </a>
                                    <a href="{% url 'storefront:cancel_subscription' store.slug %}" class="btn-custom btn-outline-danger">
                                        <i class="bi bi-x-circle me-2"></i>Cancel Subscription
                                    </a>
                                {% elif is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}
                                    <a href="{% url 'storefront:subscription_payment_options' store.slug %}" class="btn-custom btn-warning">
                                        <i class="bi bi-credit-card me-2"></i>Subscribe Now
                                    </a>
                                    <a href="{% url 'storefront:subscription_change_plan' store.slug %}" class="btn-custom btn-outline-primary">
                                        <i class="bi bi-arrow-left-right me-2"></i>Change Plan
                                    </a>
                                {% else %}
                                    {% if reactivate_available and reactivate_subscription %}
                                        {% if reactivate_subscription.status == 'unpaid' %}
                                            <a href="{% url 'storefront:subscription_payment_options' store.slug %}" class="btn-custom btn-primary">
                                                <i class="bi bi-arrow-clockwise me-2"></i>Reactivate {{ reactivate_subscription.get_plan_display }}
                                            </a>
                                        {% else %}
                                            <a href="{% url 'storefront:subscription_renew' store.slug %}" class="btn-custom btn-primary">
                                                <i class="bi bi-arrow-clockwise me-2"></i>Reactivate {{ reactivate_subscription.get_plan_display }}
                                            </a>
                                        {% endif %}
                                        <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-outline-primary">
                                            <i class="bi bi-arrow-up-circle me-2"></i>Choose Another Plan
                                        </a>
                                    {% else %}
                                        <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-primary">
                                            <i class="bi bi-arrow-up-circle me-2"></i>Upgrade Plan
                                        </a>
                                        {% if trial_available %}
                                        <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="btn-custom btn-outline-primary">
                                            <i class="bi bi-gem me-2"></i>Start Free Trial
                                        </a>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment History -->
        {% if current_plan != 'free' %}
        <div class="subscription-section animate-fade-in-up">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-credit-card-2-front"></i>
                    Payment History
                </h2>
                <span class="text-muted">{{ recent_payments|length }} payment{{ recent_payments|length|pluralize }}</span>
            </div>

            {% if recent_payments %}
            <div class="table-responsive">
                <table class="payment-table">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Phone Number</th>
                            <th>Reference ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in recent_payments %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ payment.transaction_date|date:"M d, Y" }}</div>
                                <small class="text-muted">{{ payment.transaction_date|time:"h:i A" }}</small>
                            </td>
                            <td>
                                <span class="fw-bold">KSh {{ payment.amount|intcomma }}</span>
                            </td>
                            <td>
                                {% if payment.status == 'completed' %}
                                    <span class="payment-status-badge payment-status-success">
                                        <i class="bi bi-check-circle me-1"></i>Completed
                                    </span>
                                {% elif payment.status == 'pending' %}
                                    <span class="payment-status-badge payment-status-warning">
                                        <i class="bi bi-clock me-1"></i>Pending
                                    </span>
                                {% else %}
                                    <span class="payment-status-badge payment-status-danger">
                                        <i class="bi bi-x-circle me-1"></i>Failed
                                    </span>
                                {% endif %}
                            </td>
                            <td>{{ payment.phone_number }}</td>
                            <td>
                                <code class="text-muted">{{ payment.transaction_id|truncatechars:12 }}</code>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-receipt fs-1 text-muted mb-3"></i>
                <h5 class="fw-bold text-muted mb-2">No Payment History</h5>
                <p class="text-muted mb-4">Your payment history will appear here</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Plan Comparison -->
        <div class="subscription-section animate-scale-in">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-graph-up"></i>
                    Available Plans
                </h2>
                <span class="text-muted">Choose what works for you</span>
            </div>

            <div class="plan-cards">
                {% for plan_key, plan_info in plan_details.items %}
                {% if plan_key != 'free' %}
                <div class="plan-card {% if plan_key == 'premium' %}popular{% endif %} {% if current_plan == plan_key %}border-success{% endif %}">
                    <div class="plan-card-header">
                        <h3 class="plan-card-title">{{ plan_info.name }}</h3>
                        {% if current_plan == plan_key %}
                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                            Current Plan
                        </span>
                        {% endif %}
                        <div class="plan-card-price">KSh {{ plan_info.price|floatformat:0|intcomma }}</div>
                        <div class="plan-card-period">{{ plan_info.period|title }} subscription</div>
                    </div>
                    
                    <ul class="plan-card-features">
                        {% for feature in plan_info.features %}
                        <li>
                            <i class="bi bi-check-circle-fill"></i>
                            <span>{{ feature }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    
                    <div class="plan-card-action">
                        {% if current_plan != plan_key %}
                        <a href="{% url 'storefront:subscription_plan_select' store.slug %}" 
                           class="btn-custom btn-{% if plan_key == 'premium' %}warning{% else %}outline-primary{% endif %} w-100">
                            {% if current_plan == 'free' %}
                                Select {{ plan_info.name }}
                            {% else %}
                                Switch to {{ plan_info.name }}
                            {% endif %}
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="subscription-section animate-scale-in">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-lightning-charge"></i>
                    Quick Actions
                </h2>
                <span class="text-muted">Manage your subscription</span>
            </div>

            <div class="action-buttons-grid">
                <!-- Free Plan Actions -->
                {% if current_plan == 'free' %}
                    {% if trial_available %}
                    <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="action-button action-button-primary">
                        <div class="action-button-icon">
                            <i class="bi bi-gem"></i>
                        </div>
                        <h4 class="action-button-title">Start Free Trial</h4>
                        <p class="action-button-description">Try premium features for free for 7 days</p>
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="action-button action-button-warning">
                        <div class="action-button-icon">
                            <i class="bi bi-arrow-up-circle"></i>
                        </div>
                        <h4 class="action-button-title">Upgrade Plan</h4>
                        <p class="action-button-description">Choose a paid plan to unlock premium features</p>
                    </a>
                    
                <!-- Paid Plan - Active -->
                {% elif is_paid_plan and is_active %}
                    <a href="{% url 'storefront:subscription_change_plan' store.slug %}" class="action-button action-button-primary">
                        <div class="action-button-icon">
                            <i class="bi bi-arrow-left-right"></i>
                        </div>
                        <h4 class="action-button-title">Change Plan</h4>
                        <p class="action-button-description">Upgrade or downgrade your current subscription plan</p>
                    </a>
                    
                    <a href="{% url 'storefront:cancel_subscription' store.slug %}" class="action-button action-button-danger">
                        <div class="action-button-icon">
                            <i class="bi bi-x-circle"></i>
                        </div>
                        <h4 class="action-button-title">Cancel</h4>
                        <p class="action-button-description">Cancel your subscription at the end of billing period</p>
                    </a>
                    
                <!-- Trial Active -->
                {% elif is_trialing and subscription.trial_ends_at and subscription.trial_ends_at > now %}
                    <a href="{% url 'storefront:subscription_payment_options' store.slug %}" class="action-button action-button-warning">
                        <div class="action-button-icon">
                            <i class="bi bi-credit-card"></i>
                        </div>
                        <h4 class="action-button-title">Subscribe Now</h4>
                        <p class="action-button-description">Convert your trial to a paid subscription</p>
                    </a>
                    
                    <a href="{% url 'storefront:subscription_change_plan' store.slug %}" class="action-button action-button-ghost">
                        <div class="action-button-icon">
                            <i class="bi bi-arrow-left-right"></i>
                        </div>
                        <h4 class="action-button-title">Change Plan</h4>
                        <p class="action-button-description">Select a different plan before subscribing</p>
                    </a>
                    
                <!-- Past Due or Canceled -->
                {% elif subscription.status in 'past_due,canceled'|split:',' %}
                    <a href="{% url 'storefront:subscription_renew' store.slug %}" class="action-button action-button-warning">
                        <div class="action-button-icon">
                            <i class="bi bi-arrow-clockwise"></i>
                        </div>
                        <h4 class="action-button-title">Renew Subscription</h4>
                        <p class="action-button-description">Renew your subscription to restore premium features</p>
                    </a>
                    
                    <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="action-button action-button-primary">
                        <div class="action-button-icon">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <h4 class="action-button-title">New Subscription</h4>
                        <p class="action-button-description">Start a fresh subscription with a new plan</p>
                    </a>
                    
                <!-- Trial Expired -->
                {% elif subscription.trial_ends_at and subscription.trial_ends_at < now %}
                    <a href="{% url 'storefront:subscription_plan_select' store.slug %}" class="action-button action-button-warning">
                        <div class="action-button-icon">
                            <i class="bi bi-arrow-up-circle"></i>
                        </div>
                        <h4 class="action-button-title">Subscribe Now</h4>
                        <p class="action-button-description">Start a paid subscription to regain premium features</p>
                    </a>
                    
                {% endif %}
                
                <!-- Always show dashboard back button -->
                <a href="{% url 'storefront:seller_dashboard' %}" class="action-button action-button-ghost">
                    <div class="action-button-icon">
                        <i class="bi bi-arrow-left"></i>
                    </div>
                    <h4 class="action-button-title">Back to Dashboard</h4>
                    <p class="action-button-description">Return to your main seller dashboard</p>
                </a>
            </div>
        </div>
    </div>
</div>
{% endwith %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Subscription management page loaded');
        
        // Add confirmation for cancellation
        const cancelLinks = document.querySelectorAll('a[href*="cancel_subscription"]');
        cancelLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const confirmed = confirm('Are you sure you want to cancel your subscription? Premium features will remain active until the end of your current billing period.');
                if (confirmed) {
                    window.location.href = this.href;
                }
            });
        });
        
        // Add hover effects to cards
        const cards = document.querySelectorAll('.status-card, .plan-card, .action-button');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                if (!this.classList.contains('disabled')) {
                    this.style.zIndex = '10';
                }
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.zIndex = '';
            });
        });
        
        // Add animation classes
        setTimeout(() => {
            document.querySelectorAll('.animate-fade-in, .animate-slide-up, .animate-scale-in').forEach((element, index) => {
                element.style.animationDelay = `${index * 0.1}s`;
            });
        }, 100);
    });
</script>
{% endblock %}