{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if creating_store %}Create New Store{% else %}Edit {{ store.name }}{% endif %} - Baysoko{% endblock %}

{% block content %}
<div class="container-custom py-var(--spacing-xl)">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-4 fw-bold mb-2">
                {% if creating_store %}
                <i class="bi bi-plus-circle me-2"></i>Create New Store
                {% else %}
                <i class="bi bi-pencil-square me-2"></i>Edit Store
                {% endif %}
            </h1>
            <p class="text-muted mb-0">
                {% if creating_store %}
                Start your selling journey on Baysoko
                {% else %}
                Update your store information and settings
                {% endif %}
            </p>
        </div>
        <a href="{% url 'storefront:seller_dashboard' %}" class="btn-custom btn-ghost">
            <i class="bi bi-arrow-left me-2"></i>
            Back to Dashboard
        </a>
    </div>

    <div class="row g-var(--spacing-xl)">
        <div class="col-lg-8">
            <div class="card-custom">
                <div class="card-header border-0 bg-gradient-primary text-white py-3 rounded-top">
                    <h5 class="mb-0">
                        <i class="bi bi-shop me-2 ms-2"></i>
                        {% if creating_store %}Store Setup{% else %}Store Information{% endif %}
                    </h5>
                </div>
                <div class="card-body p-3">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        {% if messages %}
                        <div class="mb-3">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Store Basic Information -->
                        <div class="row mb-var(--spacing-md)">
                            <div class="col-md-8">
                                {{ form.name|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.slug|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="mb-var(--spacing-md)">
                            {{ form.description|as_crispy_field }}
                        </div>
                        
                        <!-- Store Images -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-var(--spacing-md)">
                                <label class="form-label fw-bold d-block mb-2">
                                    Store Logo
                                    <span class="text-muted small">(Optional)</span>
                                </label>
                                <input type="file" class="form-control" name="logo" accept="image/jpeg,image/png,image/gif,image/webp">
                                <div class="form-text small mt-2">
                                    <ul class="mb-0 ps-3">
                                        <li>Allowed formats: JPG, PNG, GIF, WebP</li>
                                        <li>Maximum size: 10MB</li>
                                        <li>Recommended: 400√ó400px</li>
                                    </ul>
                                </div>
                                
                                {% if not creating_store and store.logo %}
                                <div class="mt-3 p-3 bg-var(--bg-secondary) rounded">
                                    <label class="form-label fw-bold d-block mb-2">Current Logo</label>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ store.logo.url }}" 
                                             alt="{{ store.name }} logo"
                                             class="rounded-circle me-3"
                                             style="width: 60px; height: 60px; object-fit: cover;">
                                        <div>
                                            <small class="text-muted d-block">Upload new image to replace</small>
                                            <a href="#" class="text-danger small" data-bs-toggle="modal" data-bs-target="#deleteLogoModal">
                                                <i class="bi bi-trash me-1"></i>Remove logo
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-var(--spacing-md)">
                                <label class="form-label fw-bold d-block mb-2">
                                    Store Cover Image
                                    <span class="text-muted small">(Optional)</span>
                                </label>
                                <input type="file" class="form-control" name="cover_image" accept="image/jpeg,image/png,image/gif,image/webp">
                                <div class="form-text small mt-2">
                                    <ul class="mb-0 ps-3">
                                        <li>Allowed formats: JPG, PNG, GIF, WebP</li>
                                        <li>Maximum size: 10MB</li>
                                        <li>Recommended: 1200√ó400px</li>
                                    </ul>
                                </div>
                                
                                {% if not creating_store and store.cover_image %}
                                <div class="mt-3 p-3 bg-var(--bg-secondary) rounded">
                                    <label class="form-label fw-bold d-block mb-2">Current Cover</label>
                                    <div>
                                        <img src="{{ store.cover_image.url }}" 
                                             alt="{{ store.name }} cover"
                                             class="rounded mb-2"
                                             style="width: 100%; height: 80px; object-fit: cover;">
                                        <a href="#" class="text-danger small" data-bs-toggle="modal" data-bs-target="#deleteCoverModal">
                                            <i class="bi bi-trash me-1"></i>Remove cover
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Premium Toggle (only for existing stores) -->
                        {% if not creating_store and store.owner == request.user %}
                        <div class="mb-3 p-3 bg-var(--bg-secondary) rounded">
                            <div class="form-check form-switch">
                                {{ form.is_premium|as_crispy_field }}
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Premium stores get featured placement and analytics
                            </small>
                        </div>
                        {% endif %}
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-3 mt-var(--spacing-xl)">
                            <button type="submit" class="btn-custom btn-primary px-5 py-3">
                                <i class="bi bi-check-circle me-2"></i>
                                {% if creating_store %}Create Store{% else %}Update Store{% endif %}
                            </button>
                            <a href="{% url 'storefront:seller_dashboard' %}" class="btn-custom btn-ghost px-4 py-3">
                                <i class="bi bi-x-circle me-2"></i>
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Tips Sidebar -->
        <div class="col-lg-4">
            <div class="card-custom sticky-top" style="top: 100px;">
                <div class="card-header border-0 bg-var(--bg-secondary) py-var(--spacing-lg)">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-lightbulb me-2"></i>
                        Store Setup Tips
                    </h6>
                </div>
                <div class="card-body">
                    {% if creating_store %}
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-primary mb-1">üè™ Choose a Memorable Name</h6>
                        <p class="small text-muted mb-0">Pick a name that reflects your brand and is easy to remember.</p>
                    </div>
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-success mb-1">üìù Clear Description</h6>
                        <p class="small text-muted mb-0">Describe what makes your store unique and what products you offer.</p>
                    </div>
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-warning mb-1">üñºÔ∏è Professional Branding</h6>
                        <p class="small text-muted mb-0">Use high-quality logo and cover images to build trust.</p>
                    </div>
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-info mb-1">üéØ SEO Friendly</h6>
                        <p class="small text-muted mb-0">Use relevant keywords in your store description for better visibility.</p>
                    </div>
                    {% else %}
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-primary mb-1">üìà Keep Information Updated</h6>
                        <p class="small text-muted mb-0">Regularly update your store details to maintain customer trust.</p>
                    </div>
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-success mb-1">üîÑ Refresh Your Look</h6>
                        <p class="small text-muted mb-0">Update images and descriptions to keep your store fresh.</p>
                    </div>
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-warning mb-1">üìû Clear Communication</h6>
                        <p class="small text-muted mb-0">Ensure contact information is current for customer inquiries.</p>
                    </div>
                    <div class="tip-item mb-var(--spacing-md)">
                        <h6 class="fw-bold text-info mb-1">‚≠ê Consider Premium</h6>
                        <p class="small text-muted mb-0">Upgrade to premium for better visibility and analytics.</p>
                    </div>
                    {% endif %}
                    
                    <hr class="my-var(--spacing-lg)">
                    
                    <!-- Premium CTA -->
                    {% if not creating_store and not store.is_premium %}
                    <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                        <h6 class="fw-bold text-warning mb-2">üöÄ Ready to Grow?</h6>
                        <p class="small text-muted mb-3">Upgrade to Premium for advanced features</p>
                        <a href="{% url 'storefront:upgrade' slug=store.slug %}" class="btn-custom btn-warning w-100">
                            <i class="bi bi-lightning-charge me-1"></i>
                            Upgrade to Premium
                        </a>
                    </div>
                    {% elif not creating_store and store.is_premium %}
                    <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                        <span class="badge bg-warning text-dark mb-2">
                            <i class="bi bi-star-fill me-1"></i>Premium Store
                        </span>
                        <p class="small text-success mb-0">You're enjoying premium features!</p>
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-info small mt-var(--spacing-lg)">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Need help?</strong> Contact support at help@baysoko.com
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Logo Modal -->
{% if not creating_store and store.logo %}
<div class="modal fade" id="deleteLogoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title fw-bold">Remove Logo</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-var(--spacing-xl)">
                <i class="bi bi-trash text-danger display-6 mb-3"></i>
                <p class="mb-0">Are you sure you want to remove your store logo?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <form method="post" action="{% url 'storefront:delete_logo' slug=store.slug %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-custom btn-danger">Remove Logo</button>
                </form>
                <button type="button" class="btn-custom btn-ghost" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Cover Modal -->
{% if not creating_store and store.cover_image %}
<div class="modal fade" id="deleteCoverModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title fw-bold">Remove Cover Image</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-var(--spacing-xl)">
                <i class="bi bi-trash text-danger display-6 mb-3"></i>
                <p class="mb-0">Are you sure you want to remove your store cover image?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <form method="post" action="{% url 'storefront:delete_cover' slug=store.slug %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-custom btn-danger">Remove Cover</button>
                </form>
                <button type="button" class="btn-custom btn-ghost" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
}

.tip-item {
    padding-left: var(--spacing-sm);
    border-left: 3px solid;
}

.tip-item:nth-child(1) { border-left-color: var(--primary); }
.tip-item:nth-child(2) { border-left-color: var(--success); }
.tip-item:nth-child(3) { border-left-color: var(--warning); }
.tip-item:nth-child(4) { border-left-color: var(--info); }

.form-check-input:checked {
    background-color: var(--primary);
    border-color: var(--primary);
}

.form-control:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.25rem rgba(255, 107, 53, 0.25);
}

/* File input styling */
.form-control[type="file"] {
    padding: 0.5rem;
}

.form-control[type="file"]::file-selector-button {
    background: var(--primary);
    color: white;
    border: none;
    padding: var(--spacing-xs) var(--spacing-sm);
    margin-right: var(--spacing-sm);
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.form-control[type="file"]::file-selector-button:hover {
    background: var(--primary-dark);
}

/* Toast notifications */
.toast-container {
    z-index: 9999;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate slug from store name
    const nameField = document.querySelector('input[name="name"]');
    const slugField = document.querySelector('input[name="slug"]');
    
    if (nameField && slugField) {
        nameField.addEventListener('input', function() {
            if (!slugField.value || slugField.dataset.manual !== 'true') {
                const slug = this.value
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[\s_-]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                slugField.value = slug;
            }
        });
        
        // Mark slug as manually edited
        slugField.addEventListener('input', function() {
            this.dataset.manual = 'true';
        });
    }
    
    // Form validation
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                // Show toast message
                showToast('Please fill in all required fields', 'danger');
            }
        });
    });
    
    function showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container') || createToastContainer();
        const toastId = 'toast-' + Date.now();
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
        bsToast.show();
        
        // Remove toast after it hides
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    }
});
</script>
{% endblock %}