{% extends 'base.html' %}
{% load static %}

{% block title %}{{ store.name }} - Store - HomaBay Souq{% endblock %}

{% block content %}
<div class="container py-var(--spacing-xl)">
  <!-- Store Header with Enhanced Text Overlay -->
  <div class="store-header-wrapper rounded-lg mb-2 mt-2 position-relative overflow-hidden"
       style="{% if store.cover_image %}background-image: url('{{ store.cover_image.url }}');{% else %}background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);{% endif %}">
    
    <!-- Dark overlay for better text contrast -->
    <div class="store-header-overlay position-absolute top-0 start-0 w-100 h-100"></div>
    
    <!-- Text content with multiple protection layers -->
    <div class="store-header-content position-relative z-2">
      <div class="container py-var(--spacing-xxl)">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <!-- Store name with multiple shadow layers -->
            <h1 class="display-4 fw-bold mb-3 store-title text-shadow-3d">
              <span class="store-title-text">{{ store.name }}</span>
            </h1>
            
            <!-- Store description with background -->
            <div class="store-description-container mb-4">
              <p class="lead store-description">{{ store.description|default:"Welcome to our store" }}</p>
            </div>
            
            <!-- Store Stats with protected backgrounds -->
            <div class="d-flex flex-wrap gap-4">
              <div class="stat-item text-protected">
                <div class="stat-value-bg">
                  <h3 class="fw-bold mb-0">{{ products.count }}</h3>
                </div>
                <small class="stat-label text-protected-label">Products</small>
              </div>
              <div class="stat-item text-protected">
                <div class="stat-value-bg">
                  <h3 class="fw-bold mb-0">{{ store.get_rating|default:"4.5" }}</h3>
                </div>
                <small class="stat-label text-protected-label">Rating</small>
              </div>
              <div class="stat-item text-protected">
                <div class="stat-value-bg">
                  <h3 class="fw-bold mb-0">{{ store.get_sales_count|default:"0" }}+</h3>
                </div>
                <small class="stat-label text-protected-label">Sales</small>
              </div>
            </div>
          </div>
          <div class="col-lg-4 text-center">
            <!-- Store Logo with protected background -->
            <div class="store-logo-wrapper position-relative">
              <div class="store-logo-background"></div>
              <img src="{{ store.get_logo_url|default:'https://placehold.co/200x200/c2c2c2/1f1f1f?text=Store' }}"
                   alt="{{ store.name }}"
                   class="store-logo position-relative z-1"
                   onerror="this.src='https://placehold.co/200x200/c2c2c2/1f1f1f?text=Store'">
              {% if store.is_premium %}
              <span class="premium-badge position-absolute badge-protected">
                <i class="bi bi-star-fill"></i> Premium
              </span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Store Navigation -->
  <div class="store-navigation mb-2">
    <div class="d-flex flex-wrap gap-2">
      <a href="#products" class="btn-custom btn-secondary active">Products</a>
      <a href="#about" class="btn-custom btn-ghost">About</a>
      <a href="#reviews" class="btn-custom btn-ghost">Reviews</a>
      {% if user == store.owner %}
      <a href="{% url 'storefront:store_edit' slug=store.slug %}" class="btn-custom btn-accent ms-auto">
        <i class="bi bi-pencil"></i> Edit Store
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Products Grid -->
  <section id="products" class="mb-5">
    <div class="section-header mb-2">
      <h2 class="section-title">Products ({{ products.count }})</h2>
      <p class="section-subtitle">Browse our collection</p>
    </div>
    
    {% if products %}
    <div class="grid-system">
      {% for product in products %}
      <div class="product-card card-custom">
        <!-- Product Image with Text Overlay Protection -->
        <div class="product-image-wrapper mb-3 position-relative">
          <img src="{{ product.get_image_url }}" 
               alt="{{ product.title }}"
               class="product-image"
               onerror="this.src='https://placehold.co/400x300/c2c2c2/1f1f1f?text=Product'">
          
          <!-- Image overlay for better text contrast -->
          <div class="product-image-overlay position-absolute top-0 start-0 w-100 h-100"></div>
          
          <!-- Badges with protected backgrounds -->
          <div class="product-badges position-absolute top-0 start-0 z-2">
            {% if store.is_premium %}
            <span class="badge bg-warning text-dark badge-protected">
              <i class="bi bi-star-fill"></i> Premium
            </span>
            {% endif %}
            {% if product.condition %}
            <span class="badge badge-protected">
              {{ product.get_condition_display }}
            </span>
            {% endif %}
          </div>
          
          <!-- Favorite button with contrast -->
          <div class="product-actions position-absolute top-0 end-0 z-2">
            <form action="{% url 'toggle_favorite' product.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="favorite-btn btn-protected {% if product.id in user_favorites %}active{% endif %}">
                <i class="bi bi-heart{% if product.id in user_favorites %}-fill{% endif %}"></i>
              </button>
            </form>
          </div>
        </div>
        
        <div class="product-info">
          <h3 class="product-title">{{ product.title }}</h3>
          <p class="product-description text-muted">{{ product.description|truncatewords:15 }}</p>
          
          <div class="product-meta">
            <span class="product-price fw-bold text-primary">KSh {{ product.price }}</span>
            <span class="product-rating text-protected">
              <i class="bi bi-star-fill text-warning"></i>
              {{ product.rating_average|default:"4.5" }} ({{ product.rating_count|default:"0" }} Reviews)
              
            </span>
          </div>
          
          <div class="product-cta mt-3">
            <a href="{% url 'storefront:product_detail' store_slug=store.slug slug=product.slug %}" 
               class="btn-custom btn-primary w-100">
              View Details
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state card-custom text-center py-var(--spacing-xxl)">
      <i class="bi bi-inbox display-1 text-muted mb-3"></i>
      <h3>No Products Yet</h3>
      <p class="text-muted mb-4">This store hasn't added any products yet.</p>
      {% if user == store.owner %}
      <a href="{% url 'storefront:product_create' store_slug=store.slug %}" class="btn-custom btn-primary">
        <i class="bi bi-plus-circle"></i> Add Your First Product
      </a>
      {% endif %}
    </div>
    {% endif %}
  </section>

  <!-- Store Information -->
  <section id="about" class="mb-3 mt-2">
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card-custom">
          <h3 class="mb-2">
            <i class="bi bi-info-circle text-primary me-2"></i>
            About This Store
          </h3>
          
          <div class="info-grid">
            <div class="info-item">
              <i class="bi bi-person text-primary"></i>
              <div>
                <strong>Store Owner</strong>
                <p class="mb-0">{{ store.owner.get_full_name|default:store.owner.username }}</p>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-geo-alt text-primary"></i>
              <div>
                <strong>Location</strong>
                <p class="mb-0">{{ store.location|default:"Homabay County" }}</p>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-calendar text-primary"></i>
              <div>
                <strong>Joined</strong>
                <p class="mb-0">{{ store.created_at|date:"F Y" }}</p>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-chat-dots text-primary"></i>
              <div>
                <strong>Response Time</strong>
                <p class="mb-0">Within 24 hours</p>
              </div>
            </div>
            <div class="info-item">
              <i class="bi bi-award text-primary"></i>
              <div>
                <strong>Ratings</strong>
                <p class="mb-0">{{ store.get_rating|default:"0.0" }} / 5.0</p>
              </div>
            </div>  
          </div>
          
          {% if store.policies %}
          <div class="mt-var(--spacing-lg)">
            <h4 class="mb-3">Store Policies</h4>
            <div class="policy-content bg-light p-3 rounded">{{ store.policies|linebreaks }}</div>
          </div>
          {% endif %}
        </div>
      </div>
      
      <div class="col-lg-4">
        <!-- Verification Card -->
        <div class="card-custom">
          <h3 class="mb-2">
            <i class="bi bi-shield-check text-success me-2"></i>
            Store Verification
          </h3>
          
          <div class="verification-list">
            <div class="verification-item success">
              <i class="bi bi-check-circle-fill text-success"></i>
              <div>
                <strong>Email Verified</strong>
                <small>Store owner has verified email</small>
              </div>
            </div>
            <div class="verification-item success">
              <i class="bi bi-check-circle-fill text-success"></i>
              <div>
                <strong>Phone Verified</strong>
                <small>M-Pesa number verified</small>
              </div>
            </div>
            {% if store.is_premium %}
            <div class="verification-item warning">
              <i class="bi bi-award-fill text-warning"></i>
              <div>
                <strong>Premium Store</strong>
                <small>Verified premium seller</small>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
/* Enhanced Store Detail Styles with Text Protection */
.store-header-wrapper {
  min-height: 400px;
  border-radius: var(--radius-xl);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  position: relative;
}

.store-header-overlay {
  background: linear-gradient(to bottom, 
    rgba(0, 0, 0, 0.7) 0%, 
    rgba(0, 0, 0, 0.5) 50%, 
    rgba(0, 0, 0, 0.3) 100%);
  z-index: 1;
}

.store-header-content {
  z-index: 2;
}

/* Enhanced text shadow for better readability on any background */
.store-title {
  color: white;
  position: relative;
}

.store-title-text {
  text-shadow: 
    0 2px 4px rgba(0, 0, 0, 0.8),
    0 4px 8px rgba(0, 0, 0, 0.6),
    0 8px 16px rgba(0, 0, 0, 0.4);
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-sm);
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(4px);
}

.store-description-container {
  background: rgba(0, 0, 0, 0.5);
  padding: 1rem;
  border-radius: var(--radius-md);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.store-description {
  color: white;
  margin-bottom: 0;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

/* Protected stat items */
.stat-item {
  text-align: center;
}

.stat-value-bg {
  background: rgba(0, 0, 0, 0.6);
  border-radius: var(--radius-md);
  padding: 0.5rem 1rem;
  display: inline-block;
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-item h3 {
  font-size: 2.5rem;
  margin-bottom: 0;
  color: white;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

.stat-label {
  display: block;
  margin-top: 0.5rem;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

/* Store logo with protected background */
.store-logo-wrapper {
  display: inline-block;
  position: relative;
  padding: 1rem;
}

.store-logo-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.2);
}

.store-logo {
  width: 200px;
  height: 200px;
  border-radius: var(--radius-full);
  border: 4px solid rgba(255, 255, 255, 0.3);
  background: white;
  padding: var(--spacing-xs);
  position: relative;
  z-index: 1;
}

.premium-badge {
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #333;
  padding: 0.5rem 1rem;
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 0.875rem;
  z-index: 3;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Protected badges */
.badge-protected {
  backdrop-filter: blur(10px);
  background: rgba(0, 0, 0, 0.85) !important;
  color: white !important;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  font-weight: 600;
  padding: 0.5rem 1rem;
  margin-bottom: 0.5rem;
}

.badge-protected.bg-warning {
  background: rgba(255, 193, 7, 0.95) !important;
  color: #333 !important;
}

/* Grid System */
.grid-system {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--spacing-lg);
}

.product-card {
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.product-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.product-image-wrapper {
  position: relative;
  height: 200px;
  overflow: hidden;
  border-radius: var(--radius-md);
}

.product-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s ease;
}

.product-card:hover .product-image {
  transform: scale(1.05);
}

.product-image-overlay {
  background: linear-gradient(to bottom, 
    transparent 60%, 
    rgba(0, 0, 0, 0.4) 100%);
  pointer-events: none;
  z-index: 1;
}

.product-badges {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: var(--spacing-sm);
}

.product-actions {
  padding: var(--spacing-sm);
}

.favorite-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-full);
  background: rgba(255, 255, 255, 0.95);
  border: 2px solid rgba(0, 0, 0, 0.1);
  color: #666;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.btn-protected {
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.95);
}

.favorite-btn.active {
  background: var(--danger);
  color: white;
  border-color: var(--danger);
}

.favorite-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.product-info {
  padding: var(--spacing-lg);
}

.product-title {
  font-family: var(--font-heading);
  font-size: 1.1rem;
  margin-bottom: var(--spacing-xs);
  color: var(--text-primary);
  font-weight: 600;
}

.product-description {
  color: var(--text-secondary);
  font-size: 0.9rem;
  margin-bottom: var(--spacing-md);
  line-height: 1.5;
}

.product-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
}

.product-price {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
}

.product-rating {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  color: var(--text-secondary);
  font-weight: 500;
}

/* Text protection for rating */
.text-protected {
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* Info Grid */
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--spacing-lg);
}

.info-item {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-color);
}

.info-item i {
  font-size: 1.5rem;
  color: var(--primary);
  margin-top: var(--spacing-xs);
}

.verification-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.verification-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  border-radius: var(--radius-md);
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
}

.verification-item.success i {
  color: var(--accent);
}

.verification-item.warning i {
  color: var(--warning);
}

/* Responsive Design */
@media (max-width: 768px) {
  .store-header-wrapper {
    min-height: 300px;
  }
  
  .store-logo {
    width: 150px;
    height: 150px;
  }
  
  .grid-system {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
  
  .store-title {
    font-size: 2.5rem;
  }
}

@media (max-width: 576px) {
  .grid-system {
    grid-template-columns: 1fr;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  .store-title {
    font-size: 2rem;
  }
  
  .store-logo {
    width: 120px;
    height: 120px;
  }
  
  .stat-item h3 {
    font-size: 2rem;
  }
}

/* Additional text protection classes */
.text-shadow-3d {
  text-shadow: 
    0 1px 0 #ccc,
    0 2px 0 #c9c9c9,
    0 3px 0 #bbb,
    0 4px 0 #b9b9b9,
    0 5px 0 #aaa,
    0 6px 1px rgba(0,0,0,.1),
    0 0 5px rgba(0,0,0,.1),
    0 1px 3px rgba(0,0,0,.3),
    0 3px 5px rgba(0,0,0,.2),
    0 5px 10px rgba(0,0,0,.25),
    0 10px 10px rgba(0,0,0,.2),
    0 20px 20px rgba(0,0,0,.15);
}

.text-protected-label {
  background: rgba(0, 0, 0, 0.3);
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-sm);
  display: inline-block;
  backdrop-filter: blur(4px);
}
</style>
{% endblock %}