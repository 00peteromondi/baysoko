{% extends 'base.html' %}
{% load humanize %}

{% block title %}Bulk Stock Update - {{ store.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Bulk Stock Update</h1>
            <p class="text-muted mb-0">Update stock levels for multiple products at once</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'storefront:inventory_dashboard' slug=store.slug %}" 
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </a>
            <a href="{% url 'storefront:adjust_stock' slug=store.slug %}" 
               class="btn btn-outline-primary">
                <i class="bi bi-plus-circle me-2"></i>Single Product
            </a>
        </div>
    </div>

    <!-- Bulk Update Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Bulk Stock Update Settings</h6>
                </div>
                <div class="card-body">
                    <form method="post" id="bulkUpdateForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">1. Select Update Type</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check card border p-3 h-100">
                                        <input class="form-check-input" type="radio" name="update_type" 
                                               id="update_percentage" value="percentage" checked>
                                        <label class="form-check-label fw-bold" for="update_percentage">
                                            Percentage Change
                                        </label>
                                        <p class="text-muted small mt-2 mb-0">
                                            Increase or decrease stock by percentage
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check card border p-3 h-100">
                                        <input class="form-check-input" type="radio" name="update_type" 
                                               id="update_fixed" value="fixed">
                                        <label class="form-check-label fw-bold" for="update_fixed">
                                            Fixed Amount
                                        </label>
                                        <p class="text-muted small mt-2 mb-0">
                                            Add or subtract fixed number of units
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check card border p-3 h-100">
                                        <input class="form-check-input" type="radio" name="update_type" 
                                               id="update_set" value="set">
                                        <label class="form-check-label fw-bold" for="update_set">
                                            Set Exact Quantity
                                        </label>
                                        <p class="text-muted small mt-2 mb-0">
                                            Set all products to specific stock level
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">2. Set Value</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div id="percentageFields" class="update-fields">
                                        <label class="form-label">Percentage Change</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="percentage_value" 
                                                   value="0" step="0.01" placeholder="10">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <small class="text-muted">
                                            Positive to increase, negative to decrease. Example: 10 for 10% increase
                                        </small>
                                    </div>
                                    
                                    <div id="fixedFields" class="update-fields d-none">
                                        <label class="form-label">Fixed Amount</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="fixed_value" 
                                                   value="0" step="1" placeholder="50">
                                            <span class="input-group-text">units</span>
                                        </div>
                                        <small class="text-muted">
                                            Positive to add, negative to remove. Example: -5 to remove 5 units
                                        </small>
                                    </div>
                                    
                                    <div id="setFields" class="update-fields d-none">
                                        <label class="form-label">Set Stock To</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="set_value" 
                                                   value="0" min="0" step="1" placeholder="100">
                                            <span class="input-group-text">units</span>
                                        </div>
                                        <small class="text-muted">
                                            All selected products will be set to this exact stock level
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Preview</h6>
                                            <div id="previewExample">
                                                <p class="text-muted mb-1">Example: Product with 50 units</p>
                                                <p class="fw-bold" id="previewResult">Will become 55 units</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">3. Select Products</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Apply To</label>
                                    <select class="form-select" id="applyTo" name="apply_to">
                                        <option value="all">All Products</option>
                                        <option value="category">Specific Category</option>
                                        <option value="low_stock">Low Stock Items Only</option>
                                        <option value="out_of_stock">Out of Stock Items Only</option>
                                        <option value="selected">Manually Selected Products</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3" id="categoryField">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" name="category">
                                        <option value="">Select Category</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="selectedProductsField" class="d-none">
                                <label class="form-label">Select Products</label>
                                <div class="card">
                                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllProducts">
                                            <label class="form-check-label fw-bold" for="selectAllProducts">
                                                Select All Products
                                            </label>
                                        </div>
                                        <hr>
                                        <div id="productsList">
                                            {% for product in products %}
                                            <div class="form-check mb-2">
                                                <input class="form-check-input product-checkbox" type="checkbox" 
                                                       name="selected_products" value="{{ product.id }}" 
                                                       id="product_{{ product.id }}">
                                                <label class="form-check-label" for="product_{{ product.id }}">
                                                    {{ product.title }}
                                                    <span class="text-muted small">(Stock: {{ product.stock }})</span>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Selected: <span id="selectedCount">0</span> products</small>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">4. Additional Options</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="skip_out_of_stock" 
                                               id="skip_out_of_stock" checked>
                                        <label class="form-check-label" for="skip_out_of_stock">
                                            Skip out of stock products
                                        </label>
                                        <small class="text-muted d-block">
                                            Don't apply changes to products with 0 stock
                                        </small>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="prevent_negative" 
                                               id="prevent_negative" checked>
                                        <label class="form-check-label" for="prevent_negative">
                                            Prevent negative stock
                                        </label>
                                        <small class="text-muted d-block">
                                            Stock will never go below 0 units
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Operation Notes</label>
                                        <textarea class="form-control" name="notes" rows="3" 
                                                  placeholder="Add notes about this bulk update..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" 
                                        data-bs-toggle="modal" data-bs-target="#previewModal">
                                    <i class="bi bi-eye me-2"></i>Preview Changes
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-2"></i>Apply Bulk Update
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Statistics -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Inventory Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="text-center">
                                <div class="h3 mb-0 text-primary">{{ total_products }}</div>
                                <small class="text-muted">Total Products</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="text-center">
                                <div class="h3 mb-0 text-success">{{ average_stock|floatformat:0 }}</div>
                                <small class="text-muted">Avg Stock</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="text-center">
                                <div class="h3 mb-0 text-warning">{{ low_stock_count }}</div>
                                <small class="text-muted">Low Stock</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="text-center">
                                <div class="h3 mb-0 text-danger">{{ out_of_stock_count }}</div>
                                <small class="text-muted">Out of Stock</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="fw-bold">Stock Distribution</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-success" style="width: {{ stock_distribution.good }}%">
                                Good ({{ stock_distribution.good }}%)
                            </div>
                            <div class="progress-bar bg-warning" style="width: {{ stock_distribution.low }}%">
                                Low ({{ stock_distribution.low }}%)
                            </div>
                            <div class="progress-bar bg-danger" style="width: {{ stock_distribution.out }}%">
                                Out ({{ stock_distribution.out }}%)
                            </div>
                        </div>
                        <div class="small text-muted">
                            Good: 10+ units | Low: 1-9 units | Out: 0 units
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Presets -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Presets</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-success preset-btn" 
                                data-type="percentage" data-value="10">
                            <i class="bi bi-arrow-up me-2"></i>Increase All by 10%
                        </button>
                        <button type="button" class="btn btn-outline-warning preset-btn" 
                                data-type="fixed" data-value="5">
                            <i class="bi bi-plus-circle me-2"></i>Add 5 Units to All
                        </button>
                        <button type="button" class="btn btn-outline-info preset-btn" 
                                data-type="set" data-value="20" data-apply="low_stock">
                            <i class="bi bi-arrow-up-circle me-2"></i>Set Low Stock to 20
                        </button>
                        <button type="button" class="btn btn-outline-danger preset-btn" 
                                data-type="set" data-value="0" data-apply="out_of_stock">
                            <i class="bi bi-x-circle me-2"></i>Clear Out of Stock
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview Bulk Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Calculating changes...</p>
                </div>
                
                <div id="previewContent" class="d-none">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        This is a preview. No changes have been made yet.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <div class="h4 mb-0" id="previewTotalProducts">0</div>
                                    <small class="text-muted">Total Products</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <div class="h4 mb-0 text-success" id="previewUpdated">0</div>
                                    <small class="text-muted">Will Be Updated</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <div class="h4 mb-0 text-danger" id="previewSkipped">0</div>
                                    <small class="text-muted">Will Be Skipped</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Summary</h6>
                        <div class="card">
                            <div class="card-body">
                                <p id="previewSummary"></p>
                                <p class="mb-0" id="previewNotes"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Sample Changes</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Current</th>
                                        <th>New</th>
                                        <th>Change</th>
                                    </tr>
                                </thead>
                                <tbody id="previewSampleTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBulkUpdate">
                    <i class="bi bi-check-circle me-2"></i>Confirm & Apply
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.update-fields {
    transition: all 0.3s ease;
}

.form-check.card:hover {
    border-color: #4e73df;
    cursor: pointer;
}

.form-check-input:checked + .form-check-label {
    color: #4e73df;
}

.preset-btn:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
}

#productsList {
    max-height: 250px;
    overflow-y: auto;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update type toggles
    const updateTypes = document.querySelectorAll('input[name="update_type"]');
    const updateFields = {
        percentage: document.getElementById('percentageFields'),
        fixed: document.getElementById('fixedFields'),
        set: document.getElementById('setFields')
    };
    
    updateTypes.forEach(type => {
        type.addEventListener('change', function() {
            // Hide all fields
            Object.values(updateFields).forEach(field => {
                field.classList.add('d-none');
            });
            
            // Show selected field
            updateFields[this.value].classList.remove('d-none');
            updatePreview();
        });
    });
    
    // Apply to selection
    const applyToSelect = document.getElementById('applyTo');
    const categoryField = document.getElementById('categoryField');
    const selectedProductsField = document.getElementById('selectedProductsField');
    const selectAllProducts = document.getElementById('selectAllProducts');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    
    applyToSelect.addEventListener('change', function() {
        const value = this.value;
        
        // Reset visibility
        categoryField.style.display = 'none';
        selectedProductsField.classList.add('d-none');
        
        if (value === 'category') {
            categoryField.style.display = 'block';
        } else if (value === 'selected') {
            selectedProductsField.classList.remove('d-none');
        }
    });
    
    // Select all products
    selectAllProducts.addEventListener('change', function() {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // Update selected count
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.product-checkbox:checked').length;
        selectedCount.textContent = selected;
    }
    
    // Preview calculation
    const valueInputs = document.querySelectorAll('input[name*="_value"], input[name="percentage_value"]');
    valueInputs.forEach(input => {
        input.addEventListener('input', updatePreview);
    });
    
    function updatePreview() {
        const updateType = document.querySelector('input[name="update_type"]:checked').value;
        const value = parseFloat(document.querySelector(`input[name="${updateType}_value"]`).value) || 0;
        const exampleStock = 50;
        
        let result = exampleStock;
        let description = '';
        
        switch(updateType) {
            case 'percentage':
                result = exampleStock * (1 + value / 100);
                description = `${value > 0 ? '+' : ''}${value}%`;
                break;
            case 'fixed':
                result = exampleStock + value;
                description = `${value > 0 ? '+' : ''}${value} units`;
                break;
            case 'set':
                result = value;
                description = `set to ${value} units`;
                break;
        }
        
        document.getElementById('previewResult').textContent = 
            `Will become ${Math.max(0, Math.round(result))} units (${description})`;
    }
    
    // Quick presets
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.dataset.type;
            const value = this.dataset.value;
            const apply = this.dataset.apply || 'all';
            
            // Set update type
            document.getElementById(`update_${type}`).checked = true;
            document.getElementById(`update_${type}`).dispatchEvent(new Event('change'));
            
            // Set value
            document.querySelector(`input[name="${type}_value"]`).value = value;
            
            // Set apply to
            if (apply !== 'all') {
                document.getElementById('applyTo').value = apply;
                document.getElementById('applyTo').dispatchEvent(new Event('change'));
            }
            
            updatePreview();
            showToast('Preset applied', 'success');
        });
    });
    
    // Preview modal
    const previewModal = document.getElementById('previewModal');
    previewModal.addEventListener('show.bs.modal', function() {
        const previewLoading = document.getElementById('previewLoading');
        const previewContent = document.getElementById('previewContent');
        
        previewLoading.classList.remove('d-none');
        previewContent.classList.add('d-none');
        
        // Get form data
        const formData = new FormData(document.getElementById('bulkUpdateForm'));
        
        // Simulate calculation (in real app, this would be an AJAX call)
        setTimeout(() => {
            const totalProducts = {{ total_products }};
            const updatedProducts = Math.floor(totalProducts * 0.8);
            const skippedProducts = totalProducts - updatedProducts;
            
            document.getElementById('previewTotalProducts').textContent = totalProducts;
            document.getElementById('previewUpdated').textContent = updatedProducts;
            document.getElementById('previewSkipped').textContent = skippedProducts;
            
            const updateType = formData.get('update_type');
            const value = formData.get(`${updateType}_value`);
            const applyTo = formData.get('apply_to');
            
            let summary = `Bulk ${updateType} update with value ${value}. `;
            summary += `Applied to ${applyTo.replace('_', ' ')} products.`;
            
            document.getElementById('previewSummary').textContent = summary;
            
            // Sample data
            const sampleTable = document.getElementById('previewSampleTable');
            sampleTable.innerHTML = '';
            
            const sampleProducts = [
                { name: 'Sample Product 1', current: 50, new: 55 },
                { name: 'Sample Product 2', current: 10, new: 11 },
                { name: 'Sample Product 3', current: 0, new: 0 },
                { name: 'Sample Product 4', current: 25, new: 27.5 }
            ];
            
            sampleProducts.forEach(product => {
                const change = product.new - product.current;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.current}</td>
                    <td>${product.new.toFixed(1)}</td>
                    <td class="${change > 0 ? 'text-success' : change < 0 ? 'text-danger' : 'text-muted'}">
                        ${change > 0 ? '+' : ''}${change.toFixed(1)}
                    </td>
                `;
                sampleTable.appendChild(row);
            });
            
            previewLoading.classList.add('d-none');
            previewContent.classList.remove('d-none');
        }, 1000);
    });
    
    // Confirm bulk update
    document.getElementById('confirmBulkUpdate').addEventListener('click', function() {
        const form = document.getElementById('bulkUpdateForm');
        const modal = bootstrap.Modal.getInstance(previewModal);
        
        modal.hide();
        form.submit();
    });
    
    // Form submission
    document.getElementById('bulkUpdateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate
        const updateType = document.querySelector('input[name="update_type"]:checked').value;
        const value = document.querySelector(`input[name="${updateType}_value"]`).value;
        
        if (!value) {
            showToast('Please enter a value', 'error');
            return;
        }
        
        if (applyToSelect.value === 'selected') {
            const selected = document.querySelectorAll('.product-checkbox:checked').length;
            if (selected === 0) {
                showToast('Please select at least one product', 'error');
                return;
            }
        }
        
        // Show confirmation
        if (!confirm('Are you sure you want to apply this bulk update? This action cannot be undone.')) {
            return;
        }
        
        // Submit form
        this.submit();
    });
    
    function resetForm() {
        document.getElementById('bulkUpdateForm').reset();
        updateFields.percentage.classList.remove('d-none');
        updateFields.fixed.classList.add('d-none');
        updateFields.set.classList.add('d-none');
        categoryField.style.display = 'none';
        selectedProductsField.classList.add('d-none');
        updatePreview();
        updateSelectedCount();
    }
    
    function showToast(message, type = 'info') {
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    // Initialize
    updatePreview();
    updateSelectedCount();
});
</script>
{% endblock %}