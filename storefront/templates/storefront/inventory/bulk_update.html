{% extends 'base.html' %}
{% load humanize %}

{% block title %}Bulk Stock Update - {{ store.name }}{% endblock %}

{% block extra_css %}
<style>
    /* ===== BULK UPDATE STYLES ===== */
    .bulk-header {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }

    .bulk-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #10b981, #3b82f6);
    }

    .bulk-title {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    .bulk-subtitle {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 0;
    }

    /* ===== UPDATE TYPE SELECTION ===== */
    .update-type-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .update-type-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        cursor: pointer;
        text-align: center;
    }

    .update-type-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }

    .update-type-card.selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .update-type-icon {
        font-size: 24px;
        color: var(--primary);
        background: rgba(79, 70, 229, 0.1);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
    }

    .update-type-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--text-primary);
    }

    .update-type-desc {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 0;
    }

    /* ===== FORM CONTROLS ===== */
    .form-section {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .section-header {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .section-title {
        font-size: 16px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .section-subtitle {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .form-control-custom {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 10px 14px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    .form-control-custom:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        outline: none;
    }

    .form-label-custom {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-help {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    /* ===== PREVIEW CARD ===== */
    .preview-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: 20px;
        border: 1px solid var(--border-color);
    }

    .preview-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .preview-result {
        font-size: 16px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 0;
    }

    /* ===== PRODUCT SELECTION ===== */
    .products-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 16px;
        background: var(--card-bg);
    }

    .product-check-item {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .product-check-item:hover {
        background: var(--bg-secondary);
    }

    .product-check-item:last-child {
        border-bottom: none;
    }

    .select-count {
        font-size: 11px;
        color: var(--text-secondary);
        font-weight: 600;
    }

    /* ===== STATS CARDS ===== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 16px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .stat-value {
        font-size: 20px;
        font-weight: 800;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ===== PROGRESS BAR ===== */
    .stock-progress {
        height: 20px;
        background: var(--bg-secondary);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .stock-progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .progress-good {
        background: #10b981;
    }

    .progress-low {
        background: #f59e0b;
    }

    .progress-out {
        background: #ef4444;
    }

    /* ===== QUICK PRESETS ===== */
    .presets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 20px;
    }

    .preset-btn {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 16px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        text-align: center;
        cursor: pointer;
    }

    .preset-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
        border-color: var(--primary);
    }

    .preset-icon {
        font-size: 20px;
        margin-bottom: 8px;
        color: var(--primary);
    }

    .preset-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .preset-desc {
        font-size: 10px;
        color: var(--text-secondary);
        margin-bottom: 0;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .update-type-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .presets-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 576px) {
        .update-type-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-custom py-3">
    <!-- Header -->
    <div class="bulk-header">
        <div class="d-flex justify-content-between align-items-start align-items-md-center flex-column flex-md-row gap-3">
            <div>
                <h1 class="bulk-title">Bulk Stock Update</h1>
                <p class="bulk-subtitle">Update stock levels for multiple products at once</p>
            </div>
            <div class="btn-group">
                <a href="{% url 'storefront:inventory_dashboard' slug=store.slug %}" class="btn-custom btn-outline text-primary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
                <a href="{% url 'storefront:adjust_stock' slug=store.slug %}" class="btn-custom btn-outline text-primary">
                    <i class="bi bi-plus-circle me-2"></i>Single Product
                </a>
            </div>
        </div>
    </div>

    <form id="bulkUpdateForm" method="post" action="{% url 'storefront:bulk_stock_update' slug=store.slug %}">
        {% csrf_token %}
    <div class="row">
        <!-- Left Column - Main Form -->
        <div class="col-lg-8">
            <!-- Update Type Selection -->
            <div class="form-section">
                <div class="section-header">
                    <h3 class="section-title">1. Select Update Type</h3>
                    <p class="section-subtitle">Choose how you want to update stock</p>
                </div>
                
                <div class="update-type-grid">
                    <div class="update-type-card selected" data-type="percentage">
                        <div class="update-type-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                            <i class="bi bi-percent"></i>
                        </div>
                        <div class="update-type-title">Percentage Change</div>
                        <p class="update-type-desc">Increase or decrease by percentage</p>
                    </div>
                    
                    <div class="update-type-card" data-type="fixed">
                        <div class="update-type-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="bi bi-plus-slash-minus"></i>
                        </div>
                        <div class="update-type-title">Fixed Amount</div>
                        <p class="update-type-desc">Add or subtract fixed units</p>
                    </div>
                    
                    <div class="update-type-card" data-type="set">
                        <div class="update-type-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            <i class="bi bi-arrow-right-circle"></i>
                        </div>
                        <div class="update-type-title">Set Exact Quantity</div>
                        <p class="update-type-desc">Set all to specific level</p>
                    </div>
                </div>
                
                <input type="hidden" id="updateType" name="update_type" value="percentage">
            </div>

            <!-- Value Settings -->
            <div class="form-section">
                <div class="section-header">
                    <h3 class="section-title">2. Set Value</h3>
                    <p class="section-subtitle">Configure the update amount</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div id="percentageFields" class="update-fields">
                            <label class="form-label-custom">Percentage Change</label>
                            <div class="input-group">
                                <input type="number" class="form-control-custom" id="percentageValue" 
                                       name="percentage_value" value="0" step="0.01" placeholder="10">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-help">
                                Positive to increase, negative to decrease. Example: 10 for 10% increase
                            </div>
                        </div>
                        
                        <div id="fixedFields" class="update-fields d-none">
                            <label class="form-label-custom">Fixed Amount</label>
                            <div class="input-group">
                                <input type="number" class="form-control-custom" id="fixedValue" 
                                       name="fixed_value" value="0" step="1" placeholder="50">
                                <span class="input-group-text">units</span>
                            </div>
                            <div class="form-help">
                                Positive to add, negative to remove. Example: -5 to remove 5 units
                            </div>
                        </div>
                        
                        <div id="setFields" class="update-fields d-none">
                            <label class="form-label-custom">Set Stock To</label>
                            <div class="input-group">
                                <input type="number" class="form-control-custom" id="setValue" 
                                       name="set_value" value="0" min="0" step="1" placeholder="100">
                                <span class="input-group-text">units</span>
                            </div>
                            <div class="form-help">
                                All selected products will be set to this exact stock level
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="preview-card">
                            <div class="preview-title">Preview</div>
                            <div id="previewExample">
                                <p class="text-muted mb-1">Example: Product with 50 units</p>
                                <p class="preview-result" id="previewResult">Will become 50 units</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Selection -->
            <div class="form-section">
                <div class="section-header">
                    <h3 class="section-title">3. Select Products</h3>
                    <p class="section-subtitle">Choose which products to update</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label-custom">Apply To</label>
                        <select class="form-control-custom" id="applyTo" name="apply_to">
                            <option value="all">All Products</option>
                            <option value="category">Specific Category</option>
                            <option value="low_stock">Low Stock Items Only</option>
                            <option value="out_of_stock">Out of Stock Items Only</option>
                            <option value="selected">Manually Selected Products</option>
                        </select>
                    </div>
                    <div class="col-md-6" id="categoryField" style="display: none;">
                        <label class="form-label-custom">Category</label>
                        <select class="form-control-custom" id="categorySelect" name="category">
                            <option value="">Select Category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div id="selectedProductsField" class="d-none">
                    <label class="form-label-custom d-flex justify-content-between align-items-center">
                        <span>Select Products</span>
                        <span class="select-count">Selected: <span id="selectedCount">0</span> products</span>
                    </label>
                    
                    <div class="products-list">
                        <div class="product-check-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllProducts">
                                <label class="form-check-label fw-bold" for="selectAllProducts">
                                    Select All Products
                                </label>
                            </div>
                        </div>
                        
                        <div id="productsList">
                            {% for product in products %}
                            <div class="product-check-item">
                                <div class="form-check">
                                    <input class="form-check-input product-checkbox" type="checkbox" 
                                           name="selected_products" value="{{ product.id }}" 
                                           id="product_{{ product.id }}">
                                    <label class="form-check-label" for="product_{{ product.id }}">
                                        {{ product.title }}
                                        <span class="text-muted small">(Stock: {{ product.stock }})</span>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Options -->
            <div class="form-section">
                <div class="section-header">
                    <h3 class="section-title">4. Additional Options</h3>
                    <p class="section-subtitle">Configure advanced settings</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="skipOutOfStock" checked>
                                <label class="form-check-label" for="skipOutOfStock">
                                    Skip out of stock products
                                </label>
                                <div class="form-help">
                                    Don't apply changes to products with 0 stock
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="preventNegative" checked>
                                <label class="form-check-label" for="preventNegative">
                                    Prevent negative stock
                                </label>
                                <div class="form-help">
                                    Stock will never go below 0 units
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label-custom">Operation Notes</label>
                            <textarea class="form-control-custom" id="notes" rows="3" 
                                      placeholder="Add notes about this bulk update..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between">
                <button type="button" class="btn-custom btn-outline text-secondary" onclick="resetForm()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                </button>
                <div>
                    <button type="button" class="btn-custom btn-outline text-primary me-2" 
                            data-bs-toggle="modal" data-bs-target="#previewModal">
                        <i class="bi bi-eye me-2"></i>Preview Changes
                    </button>
                    <button type="submit" class="btn-custom btn-primary" id="submitBulkUpdate">
                        <i class="bi bi-check-circle me-2"></i>Apply Bulk Update
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Stats & Presets -->
        <div class="col-lg-4">
            <!-- Statistics -->
            <div class="form-section">
                <div class="section-header">
                    <h3 class="section-title">Inventory Statistics</h3>
                    <p class="section-subtitle">Current stock overview</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value text-primary">{{ total_products }}</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value text-success">{{ average_stock|floatformat:0 }}</div>
                        <div class="stat-label">Avg Stock</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value text-warning">{{ low_stock_count }}</div>
                        <div class="stat-label">Low Stock</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value text-danger">{{ out_of_stock_count }}</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="form-label-custom">Stock Distribution</span>
                        <span class="small text-muted">Good: 10+ | Low: 1-9 | Out: 0</span>
                    </div>
                    <div class="stock-progress">
                        <div class="stock-progress-bar progress-good" style="width: {{ stock_distribution.good }}%"></div>
                        <div class="stock-progress-bar progress-low" style="width: {{ stock_distribution.low }}%"></div>
                        <div class="stock-progress-bar progress-out" style="width: {{ stock_distribution.out }}%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Presets -->
            <div class="form-section">
                <div class="section-header">
                    <h3 class="section-title">Quick Presets</h3>
                    <p class="section-subtitle">Common bulk operations</p>
                </div>
                
                <div class="presets-grid">
                    <div class="preset-btn" data-type="percentage" data-value="10">
                        <div class="preset-icon">
                            <i class="bi bi-arrow-up"></i>
                        </div>
                        <div class="preset-title">Increase All by 10%</div>
                    </div>
                    
                    <div class="preset-btn" data-type="fixed" data-value="5">
                        <div class="preset-icon">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <div class="preset-title">Add 5 Units to All</div>
                    </div>
                    
                    <div class="preset-btn" data-type="set" data-value="20" data-apply="low_stock">
                        <div class="preset-icon">
                            <i class="bi bi-arrow-up-circle"></i>
                        </div>
                        <div class="preset-title">Set Low Stock to 20</div>
                    </div>
                    
                    <div class="preset-btn" data-type="set" data-value="0" data-apply="out_of_stock">
                        <div class="preset-icon">
                            <i class="bi bi-x-circle"></i>
                        </div>
                        <div class="preset-title">Clear Out of Stock</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content text-secondary">
            <div class="modal-header">
                <h5 class="modal-title">Preview Bulk Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Calculating changes...</p>
                </div>
                
                <div id="previewContent" class="d-none">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        This is a preview. No changes have been made yet.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-value" id="previewTotalProducts">0</div>
                                <div class="stat-label">Total Products</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-value text-success" id="previewUpdated">0</div>
                                <div class="stat-label">Will Be Updated</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-value text-danger" id="previewSkipped">0</div>
                                <div class="stat-label">Will Be Skipped</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="form-label-custom mb-2">Summary</div>
                        <div class="preview-card">
                            <p id="previewSummary" class="mb-2"></p>
                            <p class="text-muted small mb-0" id="previewNotes"></p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="form-label-custom mb-2">Sample Changes</div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Current</th>
                                        <th>New</th>
                                        <th>Change</th>
                                    </tr>
                                </thead>
                                <tbody id="previewSampleTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline text-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-primary" id="confirmBulkUpdate">
                    <i class="bi bi-check-circle me-2"></i>Confirm & Apply
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update type selection
    const updateTypeCards = document.querySelectorAll('.update-type-card');
    const updateTypeInput = document.getElementById('updateType');
    
    updateTypeCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            updateTypeCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Update hidden input
            const type = this.dataset.type;
            updateTypeInput.value = type;
            
            // Show/hide fields
            document.getElementById('percentageFields').classList.add('d-none');
            document.getElementById('fixedFields').classList.add('d-none');
            document.getElementById('setFields').classList.add('d-none');
            document.getElementById(type + 'Fields').classList.remove('d-none');
            
            updatePreview();
        });
    });
    
    // Apply to selection
    const applyToSelect = document.getElementById('applyTo');
    const categoryField = document.getElementById('categoryField');
    const selectedProductsField = document.getElementById('selectedProductsField');
    const selectAllProducts = document.getElementById('selectAllProducts');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    
    applyToSelect.addEventListener('change', function() {
        const value = this.value;
        
        // Reset visibility
        categoryField.style.display = 'none';
        selectedProductsField.classList.add('d-none');
        
        if (value === 'category') {
            categoryField.style.display = 'block';
        } else if (value === 'selected') {
            selectedProductsField.classList.remove('d-none');
        }
    });
    
    // Select all products
    selectAllProducts.addEventListener('change', function() {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // Update selected count
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.product-checkbox:checked').length;
        selectedCount.textContent = selected;
    }
    
    // Preview calculation
    const valueInputs = document.querySelectorAll('#percentageValue, #fixedValue, #setValue');
    valueInputs.forEach(input => {
        input.addEventListener('input', updatePreview);
    });
    
    function updatePreview() {
        const updateType = updateTypeInput.value;
        const valueInput = document.getElementById(updateType + 'Value');
        const value = parseFloat(valueInput?.value) || 0;
        const exampleStock = 50;
        
        let result = exampleStock;
        let description = '';
        
        switch(updateType) {
            case 'percentage':
                result = exampleStock * (1 + value / 100);
                description = `${value > 0 ? '+' : ''}${value}%`;
                break;
            case 'fixed':
                result = exampleStock + value;
                description = `${value > 0 ? '+' : ''}${value} units`;
                break;
            case 'set':
                result = value;
                description = `set to ${value} units`;
                break;
        }
        
        document.getElementById('previewResult').textContent = 
            `Will become ${Math.max(0, Math.round(result))} units (${description})`;
    }
    
    // Quick presets
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.dataset.type;
            const value = this.dataset.value;
            const apply = this.dataset.apply || 'all';
            
            // Set update type
            document.querySelector(`.update-type-card[data-type="${type}"]`).click();
            
            // Set value
            document.getElementById(type + 'Value').value = value;
            
            // Set apply to
            if (apply !== 'all') {
                applyToSelect.value = apply;
                applyToSelect.dispatchEvent(new Event('change'));
            }
            
            updatePreview();
            showToast('Preset applied', 'success');
        });
    });
    
    // Preview modal
    const previewModal = document.getElementById('previewModal');
    previewModal.addEventListener('show.bs.modal', function() {
        const previewLoading = document.getElementById('previewLoading');
        const previewContent = document.getElementById('previewContent');
        
        previewLoading.classList.remove('d-none');
        previewContent.classList.add('d-none');
        
        // Simulate calculation
        setTimeout(() => {
            const totalProducts = {{ total_products }};
            const updatedProducts = Math.floor(totalProducts * 0.8);
            const skippedProducts = totalProducts - updatedProducts;
            
            document.getElementById('previewTotalProducts').textContent = totalProducts;
            document.getElementById('previewUpdated').textContent = updatedProducts;
            document.getElementById('previewSkipped').textContent = skippedProducts;
            
            const updateType = updateTypeInput.value;
            const value = document.getElementById(updateType + 'Value').value;
            const applyTo = applyToSelect.value;
            
            let summary = `Bulk ${updateType} update with value ${value}. `;
            summary += `Applied to ${applyTo.replace('_', ' ')} products.`;
            
            document.getElementById('previewSummary').textContent = summary;
            
            // Sample data
            const sampleTable = document.getElementById('previewSampleTable');
            sampleTable.innerHTML = '';
            
            const sampleProducts = [
                { name: 'Sample Product 1', current: 50, new: 55 },
                { name: 'Sample Product 2', current: 10, new: 11 },
                { name: 'Sample Product 3', current: 0, new: 0 },
                { name: 'Sample Product 4', current: 25, new: 27.5 }
            ];
            
            sampleProducts.forEach(product => {
                const change = product.new - product.current;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.current}</td>
                    <td>${product.new.toFixed(1)}</td>
                    <td class="${change > 0 ? 'text-success' : change < 0 ? 'text-danger' : 'text-muted'}">
                        ${change > 0 ? '+' : ''}${change.toFixed(1)}
                    </td>
                `;
                sampleTable.appendChild(row);
            });
            
            previewLoading.classList.add('d-none');
            previewContent.classList.remove('d-none');
        }, 1000);
    });
    
    // Confirm bulk update and submit the form to server
    document.getElementById('confirmBulkUpdate').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(previewModal);
        modal.hide();

        // Trigger native submit button click after populating hidden value
        document.getElementById('submitBulkUpdate').click();
    });

    // Form submission: populate unified fields and submit
    document.getElementById('submitBulkUpdate').addEventListener('click', function(e) {
        e.preventDefault();

        // Determine selected update type and value
        const updateType = updateTypeInput.value;
        const valueInput = document.getElementById(updateType + 'Value');
        const value = valueInput ? valueInput.value : '';

        if (value === '' || value === null) {
            showToast('Please enter a value', 'error');
            return;
        }

        if (applyToSelect.value === 'selected') {
            const selected = document.querySelectorAll('.product-checkbox:checked').length;
            if (selected === 0) {
                showToast('Please select at least one product', 'error');
                return;
            }
        }

        if (!confirm('Are you sure you want to apply this bulk update? This action cannot be undone.')) {
            return;
        }

        // Ensure form has hidden inputs the server expects: 'update_type' (already present) and 'value'
        let unifiedValue = document.getElementById('bulkValueField');
        if (!unifiedValue) {
            unifiedValue = document.createElement('input');
            unifiedValue.type = 'hidden';
            unifiedValue.name = 'value';
            unifiedValue.id = 'bulkValueField';
            document.getElementById('bulkUpdateForm').appendChild(unifiedValue);
        }
        unifiedValue.value = value;

        // Add notes and flags
        let notesField = document.getElementById('bulkNotesField');
        if (!notesField) {
            notesField = document.createElement('input');
            notesField.type = 'hidden';
            notesField.name = 'notes';
            notesField.id = 'bulkNotesField';
            document.getElementById('bulkUpdateForm').appendChild(notesField);
        }
        notesField.value = document.getElementById('notes').value || '';

        let skipField = document.getElementById('skipOutOfStockField');
        if (!skipField) {
            skipField = document.createElement('input');
            skipField.type = 'hidden';
            skipField.name = 'skip_out_of_stock';
            skipField.id = 'skipOutOfStockField';
            document.getElementById('bulkUpdateForm').appendChild(skipField);
        }
        skipField.value = document.getElementById('skipOutOfStock').checked ? '1' : '';

        let preventField = document.getElementById('preventNegativeField');
        if (!preventField) {
            preventField = document.createElement('input');
            preventField.type = 'hidden';
            preventField.name = 'prevent_negative';
            preventField.id = 'preventNegativeField';
            document.getElementById('bulkUpdateForm').appendChild(preventField);
        }
        preventField.value = document.getElementById('preventNegative').checked ? '1' : '';

        // Finally submit the form to the server
        document.getElementById('bulkUpdateForm').submit();
    });
    
    function resetForm() {
        // Reset update type
        document.querySelector('.update-type-card[data-type="percentage"]').click();
        document.getElementById('percentageValue').value = 0;
        applyToSelect.value = 'all';
        applyToSelect.dispatchEvent(new Event('change'));
        document.getElementById('notes').value = '';
        document.getElementById('skipOutOfStock').checked = true;
        document.getElementById('preventNegative').checked = true;
        
        // Reset product selection
        selectAllProducts.checked = false;
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount();
        
        updatePreview();
        showToast('Form reset', 'info');
    }
    
    function showToast(message, type = 'info') {
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    // Initialize
    updatePreview();
    updateSelectedCount();
});
</script>
{% endblock %}