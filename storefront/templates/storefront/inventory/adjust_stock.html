{% extends 'base.html' %}
{% load humanize %}

{% block title %}Adjust Stock - {{ store.name }}{% endblock %}

{% block extra_css %}
<style>
    /* ===== ADJUST STOCK STYLES ===== */
    .adjust-header {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }

    .adjust-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
    }

    .adjust-title {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    .adjust-subtitle {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 0;
    }

    /* ===== FORM CARD ===== */
    .form-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
        transition: all 0.3s ease;
    }

    .form-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }

    .form-card-header {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .form-card-title {
        font-size: 16px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .form-card-subtitle {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* ===== FORM CONTROLS ===== */
    .form-control-custom {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 10px 14px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    .form-control-custom:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        outline: none;
    }

    .form-label-custom {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-help {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    /* ===== STOCK DISPLAY ===== */
    .stock-display {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: 20px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .stock-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .stock-value {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 0;
    }

    .stock-value.current {
        color: #3b82f6;
    }

    .stock-value.new {
        color: #10b981;
    }

    /* ===== RECENT ADJUSTMENTS ===== */
    .adjustment-item {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .adjustment-item:hover {
        background: var(--bg-secondary);
    }

    .adjustment-item:last-child {
        border-bottom: none;
    }

    .adjustment-product {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .adjustment-details {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 0;
    }

    .adjustment-change {
        font-weight: 800;
        font-size: 14px;
    }

    .change-positive {
        color: #10b981;
    }

    .change-negative {
        color: #ef4444;
    }

    /* ===== LOW STOCK TABLE ===== */
    .low-stock-item {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .low-stock-item:hover {
        background: var(--bg-secondary);
    }

    .low-stock-item:last-child {
        border-bottom: none;
    }

    .product-image {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        object-fit: cover;
        background: var(--bg-secondary);
    }

    .product-info {
        flex: 1;
    }

    .product-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
        font-size: 14px;
    }

    .product-sku {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 0;
    }

    .stock-badge {
        font-size: 10px;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stock-badge.low {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .stock-badge.critical {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* ===== QUICK ACTIONS ===== */
    .quick-action-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        text-align: center;
        text-decoration: none !important;
        color: var(--text-primary) !important;
        display: block;
    }

    .quick-action-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }

    .quick-action-icon {
        font-size: 20px;
        color: white;
        background: var(--primary);
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
    }

    .quick-action-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--text-primary);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }
        
        .form-row .col-md-6 {
            width: 100%;
            margin-bottom: 16px;
        }
        
        .form-row .col-md-6:last-child {
            margin-bottom: 0;
        }
         /* Modal theming to respect card background */
       

    }
    /* Modal theming to respect card background */
    .modal-custom .modal-content {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .modal-custom .modal-header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .modal-custom .modal-body {
        background: transparent;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="container-custom py-3">
    <!-- Header -->
    <div class="adjust-header">
        <div class="d-flex justify-content-between align-items-start align-items-md-center flex-column flex-md-row gap-3">
            <div>
                <h1 class="adjust-title">Adjust Stock</h1>
                <p class="adjust-subtitle">Update stock levels for products</p>
            </div>
            <div class="btn-group">
                <a href="{% url 'storefront:inventory_dashboard' slug=store.slug %}" class="btn-custom btn-outline text-primary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Adjustment Form -->
        <div class="col-lg-8">
            <!-- Adjustment Form Card -->
            <div class="form-card">
                <div class="form-card-header">
                    <h3 class="form-card-title">Stock Adjustment Form</h3>
                    <p class="form-card-subtitle">Update product stock levels</p>
                </div>
                
                <form method="post" id="adjustStockForm">
                    {% csrf_token %}
                    <input type="hidden" name="quick_adjust" id="quickAdjustFlag" value="">
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label class="form-label-custom">Product</label>
                            <select class="form-control-custom" id="productSelect" name="product" required>
                                <option value="">Select a product</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" data-stock="{{ product.stock }}">
                                    {{ product.title }} (SKU: {{ product.sku|default:"-" }}, Stock: {{ product.stock }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="stock-display">
                                <div class="stock-label">Current Stock</div>
                                <div class="stock-value current" id="currentStock">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label-custom">Variant (Optional)</label>
                            <select class="form-control-custom" id="variantSelect" name="variant" disabled>
                                <option value="">No variant</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">Adjustment Type</label>
                            <select class="form-control-custom" id="adjustmentType" name="adjustment_type" required>
                                <option value="add">Add Stock</option>
                                <option value="remove">Remove Stock</option>
                                <option value="set">Set Exact Quantity</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label-custom">Quantity</label>
                            <input type="number" class="form-control-custom" id="quantity" name="quantity" 
                                   min="0" step="1" value="0" required>
                            <div class="form-help" id="quantityHelp">
                                Number of units to add
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stock-display">
                                <div class="stock-label">New Stock Level</div>
                                <div class="stock-value new" id="newStock">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label-custom">Reason/Notes</label>
                        <textarea class="form-control-custom" id="notes" name="notes" rows="3" 
                                  placeholder="Enter reason for stock adjustment..."></textarea>
                        <div class="form-help">
                            This will be recorded in stock movement history
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn-custom btn-outline text-secondary" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reset
                        </button>
                        <button type="submit" class="btn-custom btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Adjust Stock
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Low Stock Products -->
            <div class="form-card">
                <div class="form-card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="form-card-title">Low Stock Products</h3>
                        <p class="form-card-subtitle">{{ low_stock_products.count }} products need attention</p>
                    </div>
                    <span class="badge bg-warning">{{ low_stock_products.count }}</span>
                </div>
                
                {% if low_stock_products %}
                <div class="list-group">
                    {% for product in low_stock_products|slice:":5" %}
                    <div class="low-stock-item d-flex align-items-center gap-3">
                        <img src="{{ product.get_image_url }}" 
                             class="product-image" 
                             onerror="this.src='https://placehold.co/48x48/c2c2c2/1f1f1f?text=Product'">
                        <div class="product-info">
                            <div class="product-name">{{ product.title|truncatechars:30 }}</div>
                            <div class="product-sku">{{ product.sku|default:"No SKU" }}</div>
                        </div>
                        <div class="text-end">
                            <span class="stock-badge {% if product.stock <= 3 %}critical{% else %}low{% endif %}">
                                {{ product.stock }} units
                            </span>
                            <div class="mt-2">
                                <button class="btn-custom btn-sm btn-outline text-primary quick-fill-btn"
                                        data-product-id="{{ product.id }}"
                                        data-product-name="{{ product.title }}"
                                        data-current-stock="{{ product.stock }}">
                                    <i class="bi bi-arrow-up-circle me-1"></i> Restock
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if low_stock_products.count > 5 %}
                <div class="text-center mt-3">
                    <a href="{% url 'storefront:inventory_list' slug=store.slug %}?stock_status=low" 
                       class="btn-custom btn-sm btn-outline text-primary">
                        View All Low Stock Products
                    </a>
                </div>
                {% endif %}
                
                {% else %}
                <div class="text-center py-4">
                    <div class="empty-icon">
                        <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                    </div>
                    <h5>No low stock products</h5>
                    <p class="text-muted">All products have sufficient stock levels.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Right Column - Recent Actions -->
        <div class="col-lg-4">
            <!-- Recent Adjustments -->
            <div class="form-card mb-4">
                <div class="form-card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="form-card-title">Recent Adjustments</h3>
                        <p class="form-card-subtitle">Latest stock changes</p>
                    </div>
                    <a href="{% url 'storefront:stock_movements' slug=store.slug %}" class="btn-custom btn-sm btn-outline text-primary">
                        View All
                    </a>
                </div>
                
                {% if recent_movements %}
                <div class="list-group">
                    {% for movement in recent_movements %}
                    <div class="adjustment-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="adjustment-product">{{ movement.product.title|truncatechars:20 }}</div>
                            <div class="adjustment-change {% if movement.quantity > 0 %}change-positive{% else %}change-negative{% endif %}">
                                {% if movement.quantity > 0 %}+{% endif %}{{ movement.quantity }}
                            </div>
                        </div>
                        <div class="adjustment-details">
                            <span class="badge bg-{% if movement.movement_type == 'adjustment' %}info{% elif movement.movement_type == 'sale' %}success{% else %}warning{% endif %} me-2">
                                {{ movement.get_movement_type_display|slice:":1" }}
                            </span>
                            {{ movement.created_at|timesince }} ago • {{ movement.created_by.username|truncatechars:10 }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="empty-icon">
                        <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                    </div>
                    <h5>No recent adjustments</h5>
                    <p class="text-muted">Your stock adjustments will appear here</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Quick Actions -->
            <div class="form-card">
                <div class="form-card-header">
                    <h3 class="form-card-title">Quick Actions</h3>
                    <p class="form-card-subtitle">Common inventory tasks</p>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <a href="{% url 'storefront:bulk_stock_update' slug=store.slug %}" class="quick-action-card">
                            <div class="quick-action-icon" style="background: #4f46e5;">
                                <i class="bi bi-arrow-down-up"></i>
                            </div>
                            <div class="quick-action-title">Bulk Update</div>
                            <p class="text-muted small mb-0">Multiple products</p>
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'storefront:inventory_list' slug=store.slug %}" class="quick-action-card">
                            <div class="quick-action-icon" style="background: #10b981;">
                                <i class="bi bi-list-ul"></i>
                            </div>
                            <div class="quick-action-title">All Products</div>
                            <p class="text-muted small mb-0">View inventory</p>
                        </a>
                    </div>
                    <div class="col-md-12">
                        <button type="button" class="quick-action-card w-100" data-bs-toggle="modal" data-bs-target="#quickAdjustModal">
                            <div class="quick-action-icon" style="background: #f59e0b;">
                                <i class="bi bi-lightning"></i>
                            </div>
                            <div class="quick-action-title">Quick Adjustment</div>
                            <p class="text-muted small mb-0">Fast stock update</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Adjustment Modal -->
<div class="modal modal-custom fade" id="quickAdjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content text-secondary">
            <div class="modal-header">
                <h5 class="modal-title">Quick Stock Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Quickly adjust stock for a product without filling the full form.</p>
                
                <div class="mb-3">
                    <label class="form-label-custom">Product</label>
                    <select class="form-control-custom" id="quickProductSelect">
                        <option value="">Select a product</option>
                        {% for p in products %}
                        <option value="{{ p.id }}" data-stock="{{ p.stock }}">{{ p.title }} (SKU: {{ p.sku|default:"-" }}) — {{ p.stock }} in stock</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label-custom">New Stock Level</label>
                    <input type="number" class="form-control-custom" id="quickNewStock" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline text-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-primary" id="applyQuickAdjust">Apply</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('productSelect');
    const variantSelect = document.getElementById('variantSelect');
    const adjustmentType = document.getElementById('adjustmentType');
    const quantityInput = document.getElementById('quantity');
    const currentStock = document.getElementById('currentStock');
    const newStock = document.getElementById('newStock');
    const quantityHelp = document.getElementById('quantityHelp');
    
    // Load variants when product is selected
    productSelect.addEventListener('change', function() {
        const productId = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const currentStockValue = selectedOption.dataset.stock || 0;
        
        currentStock.textContent = currentStockValue;
        calculateNewStock();
        
        // Load variants
        if (productId) {
            fetch(`{% url 'storefront:get_product_variants' slug=store.slug product_id=0 %}`.replace('0', productId))
                .then(response => response.json())
                .then(data => {
                    variantSelect.innerHTML = '<option value="">No variant</option>';
                    
                    if (data.variants && data.variants.length > 0) {
                        variantSelect.disabled = false;
                        data.variants.forEach(variant => {
                            const option = document.createElement('option');
                            option.value = variant.id;
                            option.textContent = `${variant.name}: ${variant.value} (Stock: ${variant.stock})`;
                            variantSelect.appendChild(option);
                        });
                    } else {
                        variantSelect.disabled = true;
                    }
                });
        } else {
            variantSelect.disabled = true;
            variantSelect.innerHTML = '<option value="">No variant</option>';
        }
    });
    
    // Update help text based on adjustment type
    adjustmentType.addEventListener('change', function() {
        updateHelpText();
        calculateNewStock();
    });
    
    quantityInput.addEventListener('input', calculateNewStock);
    
    function calculateNewStock() {
        const currentValue = parseInt(currentStock.textContent) || 0;
        const quantity = parseInt(quantityInput.value) || 0;
        const type = adjustmentType.value;
        
        let result = currentValue;
        
        switch(type) {
            case 'add':
                result = currentValue + quantity;
                break;
            case 'remove':
                result = Math.max(0, currentValue - quantity);
                break;
            case 'set':
                result = quantity;
                break;
        }
        
        newStock.textContent = result;
    }
    
    function updateHelpText() {
        const type = adjustmentType.value;
        let text = '';
        
        switch(type) {
            case 'add':
                text = 'Number of units to add to current stock';
                break;
            case 'remove':
                text = 'Number of units to remove from current stock';
                break;
            case 'set':
                text = 'Exact number of units to set as new stock level';
                break;
        }
        
        quantityHelp.textContent = text;
    }
    
    // Quick fill buttons for low stock products
    document.querySelectorAll('.quick-fill-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            
            // Find and select the product
            for (let option of productSelect.options) {
                if (option.value === productId) {
                    productSelect.value = productId;
                    productSelect.dispatchEvent(new Event('change'));
                    break;
                }
            }
            
            // Set to add stock
            adjustmentType.value = 'add';
            updateHelpText();
            
            // Calculate quantity to reach 20 units (or maintain current if already higher)
            const currentStockValue = parseInt(this.dataset.currentStock) || 0;
            const targetStock = 20;
            const quantity = Math.max(0, targetStock - currentStockValue);
            
            quantityInput.value = quantity;
            calculateNewStock();
            
            // Scroll to form
            document.querySelector('#adjustStockForm').scrollIntoView({
                behavior: 'smooth'
            });
            
            showToast(`Ready to restock ${productName}`, 'info');
        });
    });
    
    // Quick selection in modal (dropdown)
    const quickProductSelect = document.getElementById('quickProductSelect');
    const quickNewStock = document.getElementById('quickNewStock');

    if (quickProductSelect) {
        quickProductSelect.addEventListener('change', function() {
            const opt = this.options[this.selectedIndex];
            const stock = opt ? opt.dataset.stock : '';
            if (quickNewStock) quickNewStock.value = stock || '';
            // store selected product id on the select element for apply handler
            quickProductSelect.dataset.selectedProduct = this.value || '';
        });
    }
    
    // Apply quick adjustment: interpret the modal value as the desired new stock level
    // and convert it to an add/remove quantity so the main form receives the delta.
    document.getElementById('applyQuickAdjust').addEventListener('click', function() {
        const selectedProductId = quickProductSelect ? quickProductSelect.value : null;
        const newStockValueRaw = document.getElementById('quickNewStock').value;
        const newStockValue = newStockValueRaw !== '' ? parseInt(newStockValueRaw, 10) : NaN;

        if (!selectedProductId || isNaN(newStockValue)) {
            alert('Please select a product and enter a valid stock level');
            return;
        }

        // Find or append the product option in the main form select so the rest of the form code works
        let optionFound = false;
        for (let option of productSelect.options) {
            if (option.value === String(selectedProductId)) {
                productSelect.value = selectedProductId;
                optionFound = true;
                break;
            }
        }

        if (!optionFound) {
            const selectedOpt = quickProductSelect.options[quickProductSelect.selectedIndex];
            if (selectedOpt) {
                const opt = document.createElement('option');
                opt.value = selectedOpt.value;
                opt.text = selectedOpt.text;
                opt.dataset.stock = selectedOpt.dataset.stock || 0;
                productSelect.appendChild(opt);
                productSelect.value = selectedOpt.value;
            }
        }

        // Ensure productSelect change handler updates currentStock before computing delta
        productSelect.dispatchEvent(new Event('change'));

        // Read current stock from the selected option (dataset set by productSelect change)
        const mainSelectedOption = productSelect.options[productSelect.selectedIndex];
        const currentStockValue = parseInt(mainSelectedOption.dataset.stock || '0', 10) || 0;

        const diff = newStockValue - currentStockValue;

        if (diff === 0) {
            showToast('No change detected — current stock already matches the value entered.', 'info');
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickAdjustModal'));
            modal.hide();
            return;
        }

        if (diff > 0) {
            adjustmentType.value = 'add';
            quantityInput.value = diff;
        } else {
            adjustmentType.value = 'remove';
            quantityInput.value = Math.abs(diff);
        }

        // mark as quick adjust so server can annotate movement notes
        const quickFlag = document.getElementById('quickAdjustFlag');
        if (quickFlag) quickFlag.value = '1';

        calculateNewStock();

        const modal = bootstrap.Modal.getInstance(document.getElementById('quickAdjustModal'));
        modal.hide();

        showToast('Product selected. Please review and submit the form.', 'success');
    });
    
    // Form submission
    document.getElementById('adjustStockForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Stock adjusted successfully', 'success');
                setTimeout(() => {
                    window.location.href = '{% url "storefront:inventory_dashboard" slug=store.slug %}';
                }, 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error adjusting stock', 'error');
        });
    });
    
    function resetForm() {
        document.getElementById('adjustStockForm').reset();
        currentStock.textContent = 0;
        newStock.textContent = 0;
        variantSelect.disabled = true;
        variantSelect.innerHTML = '<option value="">No variant</option>';
        updateHelpText();
    }
    
    function showToast(message, type = 'info') {
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    // Initialize
    updateHelpText();
});
</script>
{% endblock %}