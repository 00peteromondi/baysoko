{% extends 'base.html' %}
{% load humanize %}

{% block title %}Adjust Stock - {{ store.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Adjust Stock</h1>
            <p class="text-muted mb-0">Update stock levels for products</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'storefront:inventory_dashboard' slug=store.slug %}" 
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Adjustment Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Stock Adjustment Form</h6>
                </div>
                <div class="card-body">
                    <form method="post" id="adjustStockForm">
                        {% csrf_token %}
                        
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <label class="form-label">Product *</label>
                                <select class="form-select" id="productSelect" name="product" required>
                                    <option value="">Select a product</option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}" data-stock="{{ product.stock }}">
                                        {{ product.title }} (SKU: {{ product.sku|default:"-" }}, Stock: {{ product.stock }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Current Stock</label>
                                <input type="text" class="form-control" id="currentStock" readonly value="0">
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Variant (Optional)</label>
                                <select class="form-select" id="variantSelect" name="variant" disabled>
                                    <option value="">No variant</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Adjustment Type *</label>
                                <select class="form-select" id="adjustmentType" name="adjustment_type" required>
                                    <option value="add">Add Stock</option>
                                    <option value="remove">Remove Stock</option>
                                    <option value="set">Set Exact Quantity</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Quantity *</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" 
                                       min="0" step="1" value="0" required>
                                <small class="text-muted" id="quantityHelp">
                                    Number of units to add
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">New Stock Level</label>
                                <input type="text" class="form-control" id="newStock" readonly value="0">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Reason/Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Enter reason for stock adjustment..."></textarea>
                            <small class="text-muted">This will be recorded in stock movement history</small>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Reset
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Adjust Stock
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Recent Adjustments -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Adjustments</h6>
                    <a href="{% url 'storefront:stock_movements' slug=store.slug %}" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for movement in recent_movements %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ movement.product.title }}</h6>
                                <small class="text-{% if movement.quantity > 0 %}success{% else %}danger{% endif %}">
                                    {% if movement.quantity > 0 %}+{% endif %}{{ movement.quantity }}
                                </small>
                            </div>
                            <p class="mb-1 small">
                                <span class="badge bg-{% if movement.movement_type == 'adjustment' %}info{% elif movement.movement_type == 'sale' %}success{% else %}warning{% endif %}">
                                    {{ movement.get_movement_type_display }}
                                </span>
                                {% if movement.variant %}
                                <span class="badge bg-secondary">{{ movement.variant.name }}: {{ movement.variant.value }}</span>
                                {% endif %}
                            </p>
                            <small class="text-muted">
                                {{ movement.created_at|timesince }} ago by {{ movement.created_by.username }}
                            </small>
                        </div>
                        {% empty %}
                        <div class="text-center py-3">
                            <i class="bi bi-inbox text-muted display-6"></i>
                            <p class="text-muted mt-2">No recent adjustments</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'storefront:bulk_stock_update' slug=store.slug %}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-up-down me-2"></i>Bulk Update Stock
                        </a>
                        <a href="{% url 'storefront:inventory_list' slug=store.slug %}" class="btn btn-outline-secondary">
                            <i class="bi bi-list-ul me-2"></i>View All Products
                        </a>
                        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#quickAdjustModal">
                            <i class="bi bi-lightning me-2"></i>Quick Adjustment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Low Stock Products -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Low Stock Products</h6>
            <span class="badge bg-warning">{{ low_stock_products.count }} products</span>
        </div>
        <div class="card-body">
            {% if low_stock_products %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Current Stock</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in low_stock_products|slice:":10" %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="{{ product.get_image_url }}" 
                                         class="rounded me-2" 
                                         style="width: 40px; height: 40px; object-fit: cover;"
                                         onerror="this.src='https://placehold.co/40x40/c2c2c2/1f1f1f?text=Product'">
                                    <div>
                                        <a href="{% url 'storefront:product_detail' store_slug=store.slug slug=product.slug %}" 
                                           class="fw-bold text-dark">
                                            {{ product.title }}
                                        </a>
                                        <p class="mb-0 small text-muted">{{ product.sku|default:"No SKU" }}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-warning">{{ product.stock }}</span>
                            </td>
                            <td>KSh {{ product.price|intcomma }}</td>
                            <td>
                                {% if product.category %}
                                <span class="badge bg-info">{{ product.category.name }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary quick-fill-btn"
                                        data-product-id="{{ product.id }}"
                                        data-product-name="{{ product.title }}"
                                        data-current-stock="{{ product.stock }}">
                                    <i class="bi bi-arrow-up-circle"></i> Restock
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if low_stock_products.count > 10 %}
                <div class="text-center mt-3">
                    <a href="{% url 'storefront:inventory_list' slug=store.slug %}?stock_status=low" 
                       class="btn btn-sm btn-outline-secondary">
                        View All Low Stock Products
                    </a>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                <h5>No low stock products</h5>
                <p class="text-muted">All products have sufficient stock levels.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Adjustment Modal -->
<div class="modal fade" id="quickAdjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Stock Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Quickly adjust stock for a product without filling the full form.</p>
                
                <div class="mb-3">
                    <label class="form-label">Product Name or SKU</label>
                    <input type="text" class="form-control" id="quickSearch" 
                           placeholder="Start typing to search...">
                    <div id="quickSearchResults" class="mt-2 d-none">
                        <div class="list-group" id="searchResultsList"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">New Stock Level</label>
                    <input type="number" class="form-control" id="quickNewStock" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyQuickAdjust">Apply</button>
            </div>
        </div>
    </div>
</div>

<style>
#adjustStockForm .form-control:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

#newStock {
    font-weight: bold;
    color: #1cc88a;
}

#currentStock {
    font-weight: bold;
    color: #36b9cc;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('productSelect');
    const variantSelect = document.getElementById('variantSelect');
    const adjustmentType = document.getElementById('adjustmentType');
    const quantityInput = document.getElementById('quantity');
    const currentStock = document.getElementById('currentStock');
    const newStock = document.getElementById('newStock');
    const quantityHelp = document.getElementById('quantityHelp');
    
    // Load variants when product is selected
    productSelect.addEventListener('change', function() {
        const productId = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const currentStockValue = selectedOption.dataset.stock || 0;
        
        currentStock.value = currentStockValue;
        calculateNewStock();
        
        // Load variants
        if (productId) {
            fetch(`{% url 'storefront:get_product_variants' slug=store.slug product_id=0 %}`.replace('0', productId))
                .then(response => response.json())
                .then(data => {
                    variantSelect.innerHTML = '<option value="">No variant</option>';
                    
                    if (data.variants && data.variants.length > 0) {
                        variantSelect.disabled = false;
                        data.variants.forEach(variant => {
                            const option = document.createElement('option');
                            option.value = variant.id;
                            option.textContent = `${variant.name}: ${variant.value} (Stock: ${variant.stock})`;
                            variantSelect.appendChild(option);
                        });
                    } else {
                        variantSelect.disabled = true;
                    }
                });
        } else {
            variantSelect.disabled = true;
            variantSelect.innerHTML = '<option value="">No variant</option>';
        }
    });
    
    // Update help text based on adjustment type
    adjustmentType.addEventListener('change', function() {
        updateHelpText();
        calculateNewStock();
    });
    
    quantityInput.addEventListener('input', calculateNewStock);
    
    function calculateNewStock() {
        const currentValue = parseInt(currentStock.value) || 0;
        const quantity = parseInt(quantityInput.value) || 0;
        const type = adjustmentType.value;
        
        let result = currentValue;
        
        switch(type) {
            case 'add':
                result = currentValue + quantity;
                break;
            case 'remove':
                result = Math.max(0, currentValue - quantity);
                break;
            case 'set':
                result = quantity;
                break;
        }
        
        newStock.value = result;
    }
    
    function updateHelpText() {
        const type = adjustmentType.value;
        let text = '';
        
        switch(type) {
            case 'add':
                text = 'Number of units to add to current stock';
                break;
            case 'remove':
                text = 'Number of units to remove from current stock';
                break;
            case 'set':
                text = 'Exact number of units to set as new stock level';
                break;
        }
        
        quantityHelp.textContent = text;
    }
    
    // Quick fill buttons for low stock products
    document.querySelectorAll('.quick-fill-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            
            // Find and select the product
            for (let option of productSelect.options) {
                if (option.value === productId) {
                    productSelect.value = productId;
                    productSelect.dispatchEvent(new Event('change'));
                    break;
                }
            }
            
            // Set to add stock
            adjustmentType.value = 'add';
            updateHelpText();
            
            // Calculate quantity to reach 20 units (or maintain current if already higher)
            const currentStockValue = parseInt(this.dataset.currentStock) || 0;
            const targetStock = 20;
            const quantity = Math.max(0, targetStock - currentStockValue);
            
            quantityInput.value = quantity;
            calculateNewStock();
            
            // Scroll to form
            document.querySelector('#adjustStockForm').scrollIntoView({
                behavior: 'smooth'
            });
            
            showToast(`Ready to restock ${productName}`, 'info');
        });
    });
    
    // Quick search in modal
    const quickSearch = document.getElementById('quickSearch');
    const searchResults = document.getElementById('quickSearchResults');
    const searchResultsList = document.getElementById('searchResultsList');
    
    let searchTimeout;
    quickSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.classList.add('d-none');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/dashboard/store/${'{{ store.slug }}'}/inventory/search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    searchResultsList.innerHTML = '';
                    
                    if (data.products && data.products.length > 0) {
                        data.products.forEach(product => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${product.title}</h6>
                                    <small class="text-muted">${product.stock} in stock</small>
                                </div>
                                <p class="mb-1 small">${product.sku ? 'SKU: ' + product.sku : 'No SKU'}</p>
                                <small class="text-muted">KSh ${product.price}</small>
                            `;
                            
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                quickSearch.value = product.title;
                                searchResults.classList.add('d-none');
                            });
                            
                            searchResultsList.appendChild(item);
                        });
                        searchResults.classList.remove('d-none');
                    } else {
                        searchResults.classList.add('d-none');
                    }
                });
        }, 300);
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchResults.contains(e.target) && e.target !== quickSearch) {
            searchResults.classList.add('d-none');
        }
    });
    
    // Apply quick adjustment
    document.getElementById('applyQuickAdjust').addEventListener('click', function() {
        const productName = quickSearch.value;
        const newStockValue = document.getElementById('quickNewStock').value;
        
        if (!productName || !newStockValue) {
            alert('Please select a product and enter stock level');
            return;
        }
        
        // Find product by name
        let productId = null;
        for (let option of productSelect.options) {
            if (option.text.includes(productName)) {
                productId = option.value;
                break;
            }
        }
        
        if (productId) {
            productSelect.value = productId;
            productSelect.dispatchEvent(new Event('change'));
            adjustmentType.value = 'set';
            quantityInput.value = newStockValue;
            calculateNewStock();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickAdjustModal'));
            modal.hide();
            
            showToast('Product selected. Please review and submit the form.', 'success');
        } else {
            alert('Product not found. Please try again.');
        }
    });
    
    // Form submission
    document.getElementById('adjustStockForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Stock adjusted successfully', 'success');
                setTimeout(() => {
                    window.location.href = '{% url "storefront:inventory_dashboard" slug=store.slug %}';
                }, 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error adjusting stock', 'error');
        });
    });
    
    function resetForm() {
        document.getElementById('adjustStockForm').reset();
        currentStock.value = 0;
        newStock.value = 0;
        variantSelect.disabled = true;
        variantSelect.innerHTML = '<option value="">No variant</option>';
        updateHelpText();
    }
    
    function showToast(message, type = 'info') {
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    // Initialize
    updateHelpText();
});
</script>
{% endblock %}