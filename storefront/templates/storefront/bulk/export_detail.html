<!-- storefront/templates/storefront/bulk/export_detail.html -->
{% extends 'base.html' %}
{% load humanize %}

{% block title %}Export #{{ job.id }} - {{ store.name }}{% endblock %}

{% block extra_css %}
<style>
    .export-detail-header {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }
    
    .export-detail-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, 
            {% if job.status == 'completed' %}#28a745
            {% elif job.status == 'processing' %}#ffc107
            {% elif job.status == 'failed' %}#dc3545
            {% else %}#6c757d{% endif %}, 
            {% if job.status == 'completed' %}#20c997
            {% elif job.status == 'processing' %}#fd7e14
            {% elif job.status == 'failed' %}#c82333
            {% else %}#adb5bd{% endif %});
    }
    
    .export-id {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .export-title {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 8px;
        color: var(--text-primary);
    }
    
    .export-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 16px;
    }
    
    .export-stat-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        text-align: center;
        border: 1px solid var(--border-color);
        margin-bottom: 16px;
    }
    
    .export-stat-value {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 4px;
        color: var(--text-primary);
    }
    
    .export-stat-label {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .file-info-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid var(--border-color);
    }
    
    .file-details {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .file-icon {
        font-size: 48px;
        color: var(--primary);
    }
    
    .file-content {
        flex: 1;
    }
    
    .file-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
        font-size: 16px;
    }
    
    .file-meta {
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .download-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    
    .filters-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid var(--border-color);
    }
    
    .filter-item {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .filter-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .filter-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    
    .filter-value {
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .columns-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 8px;
        margin-top: 12px;
    }
    
    .column-item {
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-custom py-3">
    <!-- Header -->
    <div class="export-detail-header">
        <div class="d-flex justify-content-between align-items-start align-items-md-center flex-column flex-md-row gap-3">
            <div>
                <div class="export-id">EXPORT #{{ job.id }}</div>
                <h1 class="export-title">{{ job.export_type|title }} Export</h1>
                <div class="export-meta">
                    <div class="meta-item">
                        <span class="meta-label">Status:</span>
                        <span class="meta-value">
                            {% if job.status == 'completed' %}
                            <span class="job-badge badge-completed">{{ job.get_status_display }}</span>
                            {% elif job.status == 'processing' %}
                            <span class="job-badge badge-processing">{{ job.get_status_display }}</span>
                            {% elif job.status == 'failed' %}
                            <span class="job-badge badge-failed">{{ job.get_status_display }}</span>
                            {% else %}
                            <span class="job-badge badge-pending">{{ job.get_status_display }}</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="meta-item">
                        <span class="meta-label">Format:</span>
                        <span class="meta-value">
                            {% if job.format == 'csv' %}
                            <span class="format-badge badge-csv">CSV</span>
                            {% elif job.format == 'excel' %}
                            <span class="format-badge badge-excel">Excel</span>
                            {% elif job.format == 'json' %}
                            <span class="format-badge badge-json">JSON</span>
                            {% elif job.format == 'pdf' %}
                            <span class="format-badge badge-pdf">PDF</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="meta-item">
                        <span class="meta-label">Created:</span>
                        <span class="meta-value">{{ job.created_at|date:"M d, Y H:i" }}</span>
                    </div>
                    
                    <div class="meta-item">
                        <span class="meta-label">Created By:</span>
                        <span class="meta-value">{{ job.created_by.username }}</span>
                    </div>
                    
                    {% if job.completed_at %}
                    <div class="meta-item">
                        <span class="meta-label">Completed:</span>
                        <span class="meta-value">{{ job.completed_at|date:"M d, H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="job-actions">
                <a href="{% url 'storefront:export_job_list' slug=store.slug %}" class="btn-custom btn-outline text-primary">
                    <i class="bi bi-arrow-left me-2"></i>All Exports
                </a>
                
                {% if job.status == 'completed' and job.file %}
                <a href="{% url 'storefront:download_export' slug=store.slug job_id=job.id %}" 
                   class="btn-custom btn-primary">
                    <i class="bi bi-download me-2"></i>Download File
                </a>
                {% endif %}
                
                {% if job.status == 'failed' %}
                <a href="{% url 'storefront:export_data' slug=store.slug %}" class="btn-custom btn-outline text-danger">
                    <i class="bi bi-arrow-clockwise me-2"></i>Retry
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="row">
        <div class="col-md-3">
            <div class="export-stat-card">
                <div class="export-stat-value">{{ job.record_count|default:0|intcomma }}</div>
                <div class="export-stat-label">Records</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="export-stat-card">
                <div class="export-stat-value">
                    {% if job.file_size > 0 %}
                    {{ job.file_size|filesizeformat }}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="export-stat-label">File Size</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="export-stat-card">
                <div class="export-stat-value">{{ job.download_count }}</div>
                <div class="export-stat-label">Downloads</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="export-stat-card">
                <div class="export-stat-value">
                    {% if job.completed_at %}
                    {{ job.completed_at|timesince:job.created_at }}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="export-stat-label">Processing Time</div>
            </div>
        </div>
    </div>

    <!-- File Information -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="file-info-card">
                <h4 class="mb-4">Export File</h4>
                
                {% if job.file %}
                <div class="file-details">
                    <div class="file-icon">
                        {% if job.format == 'csv' %}
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                        {% elif job.format == 'excel' %}
                        <i class="bi bi-file-earmark-excel"></i>
                        {% elif job.format == 'json' %}
                        <i class="bi bi-file-earmark-code"></i>
                        {% elif job.format == 'pdf' %}
                        <i class="bi bi-file-earmark-pdf"></i>
                        {% else %}
                        <i class="bi bi-file-earmark"></i>
                        {% endif %}
                    </div>
                    <div class="file-content">
                        <div class="file-name">{{ job.filename }}</div>
                        <div class="file-meta">
                            {{ job.file_size|filesizeformat }} • 
                            {{ job.record_count|default:0 }} records •
                            Created {{ job.created_at|date:"M d, Y" }}
                        </div>
                    </div>
                </div>
                
                <div class="download-actions">
                    <a href="{% url 'storefront:download_export' slug=store.slug job_id=job.id %}" 
                       class="btn-custom btn-primary">
                        <i class="bi bi-download me-2"></i>Download File
                    </a>
                    
                    {% if job.format == 'csv' or job.format == 'excel' %}
                    <button type="button" class="btn-custom btn-outline text-primary" onclick="previewData()">
                        <i class="bi bi-eye me-2"></i>Preview Data
                    </button>
                    {% endif %}
                    
                    <button type="button" class="btn-custom btn-outline text-secondary" onclick="copyDownloadLink()">
                        <i class="bi bi-link me-2"></i>Copy Link
                    </button>
                </div>
                {% elif job.status == 'processing' %}
                <div class="text-center py-4">
                    <div class="empty-icon mb-3">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <h5 class="mb-2">Processing Export</h5>
                    <p class="text-muted mb-4">Your export is being generated. This may take a few minutes.</p>
                    <div class="progress-large">
                        <div class="progress-bar-large progress-warning" id="progressBar"></div>
                    </div>
                    <small class="text-muted mt-2" id="progressText">Checking progress...</small>
                </div>
                {% elif job.status == 'failed' %}
                <div class="text-center py-4">
                    <div class="empty-icon mb-3 text-danger">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <h5 class="mb-2">Export Failed</h5>
                    <p class="text-muted mb-4">{{ job.error_message|default:"An error occurred during export generation." }}</p>
                    <a href="{% url 'storefront:export_data' slug=store.slug %}" class="btn-custom btn-primary">
                        <i class="bi bi-arrow-clockwise me-2"></i>Try Again
                    </a>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="empty-icon mb-3">
                        <i class="bi bi-clock"></i>
                    </div>
                    <h5 class="mb-2">Export Pending</h5>
                    <p class="text-muted mb-4">Your export is queued and will start processing soon.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="filters-card">
                <h4 class="mb-4">Export Configuration</h4>
                
                <div class="filter-item">
                    <div class="filter-label">Export Type</div>
                    <div class="filter-value">{{ job.export_type|title }}</div>
                </div>
                
                <div class="filter-item">
                    <div class="filter-label">Export Format</div>
                    <div class="filter-value">{{ job.get_format_display }}</div>
                </div>
                
                {% if job.filters %}
                <div class="filter-item">
                    <div class="filter-label">Filters Applied</div>
                    <div class="filter-value">
                        {% for key, value in job.filters.items %}
                        <div class="mb-1">
                            <small class="text-muted">{{ key|title }}:</small>
                            <br>
                            {% if value|isinstance:'list' %}
                            {{ value|join:", " }}
                            {% else %}
                            {{ value }}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if job.columns %}
                <div class="filter-item">
                    <div class="filter-label">Columns Exported</div>
                    <div class="columns-list">
                        {% for column in job.columns %}
                        <div class="column-item">{{ column }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-refresh for processing jobs
        {% if job.status == 'processing' %}
        checkExportProgress();
        {% endif %}
        
        function checkExportProgress() {
            fetch(`{% url 'storefront:get_job_progress' slug=store.slug job_id=job.id %}`)
                .then(response => response.json())
                .then(data => {
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    if (progressBar) {
                        progressBar.style.width = data.progress_percentage + '%';
                        progressText.textContent = data.processed_items + '/' + data.total_items + ' items processed';
                    }
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        location.reload();
                    } else {
                        setTimeout(checkExportProgress, 5000);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                    setTimeout(checkExportProgress, 10000);
                });
        }
        
        window.previewData = function() {
            // In a real implementation, this would fetch and display data preview
            alert('Data preview would open here in a real implementation.');
        };
        
        window.copyDownloadLink = function() {
            const downloadUrl = '{% url "storefront:download_export" slug=store.slug job_id=job.id %}';
            const fullUrl = window.location.origin + downloadUrl;
            
            navigator.clipboard.writeText(fullUrl).then(() => {
                alert('Download link copied to clipboard!');
            });
        };
    });
</script>
{% endblock %}